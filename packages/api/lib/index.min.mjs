/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
import{SystemEvents as e}from"@convertcom/js-sdk-enums";import{objectDeepValue as t,HttpClient as s}from"@convertcom/js-sdk-utils";function i(e,t,s,i){return new(s||(s=Promise))((function(n,r){function o(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}u((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const n=process.env.CONFIG_ENDPOINT||"https://cdn-4.convertexperiments.com/api/v1/",r=process.env.TRACK_ENDPOINT||"https://[project_id].metrics.convertexperiments.com/v1/",o={"Content-type":"application/json"};class a{constructor(e,{eventManager:s,loggerManager:i}={}){var a,u,c;this._configEndpoint=n,this._trackEndpoint=r,this._defaultHeaders=o,this.batchSize=10,this.releaseInterval=1e4,this._loggerManager=i,this._eventManager=s,this._configEndpoint=t(e,"api.endpoint.config",n),this._trackEndpoint=t(e,"api.endpoint.track",r),this._data=t(e,"data"),this._enrichData=!(null==e?void 0:e.dataStore),this.batchSize=Number(t(e,"events.batch_size")).valueOf()||10,this.releaseInterval=Number(t(e,"events.release_interval")).valueOf()||1e4,this._accountId=null===(a=this._data)||void 0===a?void 0:a.account_id,this._projectId=null===(c=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===c?void 0:c.id,this._trackingEvent={enrichData:this._enrichData,accountId:this._accountId,projectId:this._projectId,visitors:[]},this._requestsQueue={length:0,items:[],push(e,t,s){const i=this.items.findIndex((t=>t.visitorId===e));if(-1!==i)this.items[i].events.push(t);else{const i={visitorId:e,events:[t]};s&&(i.segments=s),this.items.push(i)}this.length++},reset(){this.items=[],this.length=0}}}request(e,t,n={},r={}){return i(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},this._defaultHeaders),r),o={method:e,path:t.route,baseURL:t.base,headers:i,data:n,responseType:"json"};return s.request(o)}))}enqueue(e,t,s){this._requestsQueue.push(e,t,s),this._requestsQueue.length===this.batchSize?this.releaseQueue("size").then():1===this._requestsQueue.length&&this.startQueue()}releaseQueue(t){if(!this._requestsQueue.length)return;this.stopQueue();const s=this._trackingEvent;return s.visitors=this._requestsQueue.items.slice(),this.request("post",{base:this._trackEndpoint.replace("[project_id]",this._projectId.toString()),route:`/track/${this._accountId}/${this._projectId}`},s).then((s=>{var i,n;this._requestsQueue.reset(),null===(n=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===n||n.call(i,e.API_QUEUE_RELEASED,{reason:t,result:s})})).catch((s=>{var i,n;this.startQueue(),null===(n=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===n||n.call(i,e.API_QUEUE_RELEASED,{reason:t},s)}))}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}setData(e){var t;this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id,this._trackingEvent.accountId=this._accountId,this._trackingEvent.projectId=this._projectId}getConfigByKey(e){return new Promise(((t,s)=>{this.request("get",{base:this._configEndpoint,route:`/config/${e}`}).then((({data:e})=>t(e))).catch(s)}))}}export{a as ApiManager};
//# sourceMappingURL=index.min.mjs.map
