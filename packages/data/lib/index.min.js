/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/js-sdk-utils"),t=require("@convertcom/js-sdk-enums");class i{constructor(e,{dataStore:t,eventManager:i,loggerManager:l}={}){this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=l,this._eventManager=i,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=t,this._requestsQueue={}}set(e,t){var i,l,n,r;try{null===(l=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===l||l.call(i,e,t)}catch(e){null===(r=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===r||r.call(n,"DataStoreManager.set()",{error:e.message})}}get(e){var t,i,l,n;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===n||n.call(l,"DataStoreManager.get()",{error:e.message})}return null}enqueue(t,i){var l,n;null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===n||n.call(l,"DataStoreManager.enqueue()",{key:t,data:i});const r={};r[t]=i,this._requestsQueue=e.objectDeepMerge(this._requestsQueue,r),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var i,l,n,r;null===(l=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===l||l.call(i,"DataStoreManager.releaseQueue()",{reason:e||""}),this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(r=null===(n=this._eventManager)||void 0===n?void 0:n.fire)||void 0===r||r.call(n,t.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){var i,l;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(l=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===l||l.call(i,t.ERROR_MESSAGES.DATA_STORE_NOT_VALID))}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}exports.DataManager=class{constructor(i,{bucketingManager:l,ruleManager:n,eventManager:r,apiManager:a,loggerManager:o}){var s,d,u,g,v;this._dataEntities=t.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=a,this._bucketingManager=l,this._ruleManager=n,this._loggerManager=o,this._eventManager=r,this._config=i,this._data=e.objectDeepValue(i,"data"),this._accountId=null===(s=this._data)||void 0===s?void 0:s.account_id,this._projectId=null===(u=null===(d=this._data)||void 0===d?void 0:d.project)||void 0===u?void 0:u.id,this.dataStoreManager=e.objectDeepValue(i,"dataStore"),null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.trace)||void 0===v||v.call(g,t.MESSAGES.DATA_CONSTRUCTOR,this)}set data(e){var i,l,n;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(i=null==e?void 0:e.project)||void 0===i?void 0:i.id):null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===n||n.call(l,t.ERROR_MESSAGES.CONFIG_DATA_NOT_VALID)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,this._dataStoreManager=new i(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})}get dataStoreManager(){return this._dataStoreManager}matchRulesByField(e,i,l,n,r="key",a=this._environment){var o,s,d,u,g,v,c,h,_,S,M,E,y,f,I,m,p,O,T,b,A;null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.trace)||void 0===s||s.call(o,"DataManager.matchRulesByField()",{visitorId:e,identity:i,visitorProperties:l,locationProperties:n,identityField:r,environment:a});const D=this._getEntityByField(i,"experiences",r),R=!!this.getEntitiesList("archived_experiences").find((e=>String(null==D?void 0:D.id)===String(e))),k=!Array.isArray(null==D?void 0:D.environments)||(!D.environments.length||D.environments.includes(a)),N=this.getLocalStore(e)||{},{locations:B=[]}=N;let L=[];if(D&&!R&&k){let i=!1,r=[];if(n){if(Array.isArray(null==D?void 0:D.locations)&&D.locations.length){if(r=D.locations.filter((e=>B.includes(e.toString()))),!r.length){const e=this.getItemsByIds(D.locations,"locations");if(e.length&&(r=this.filterMatchedRecordsWithRule(e,n),L=r.filter((e=>Object.values(t.RuleError).includes(e))),L.length))return L[0]}i=Boolean(r.length)}else if(null==D?void 0:D.site_area){if(i=this._ruleManager.isRuleMatched(n,D.site_area),Object.values(t.RuleError).includes(i))return i}else i=!0;i&&(null===(u=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===u||u.call(d,t.MESSAGES.LOCATION_MATCH),null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.debug)||void 0===v||v.call(g,{locationProperties:n}))}if(!n||i){let i=[],n=[],r=[],a=[];if(l&&Array.isArray(null==D?void 0:D.audiences)&&D.audiences.length){if(i=this.getItemsByIds(D.audiences,"audiences"),i.length&&(r=this.filterMatchedRecordsWithRule(i,l),L=r.filter((e=>Object.values(t.RuleError).includes(e))),L.length))return L[0];n=this.getItemsByIds(D.audiences,"segments"),n.length&&(a=this.filterMatchedCustomSegments(n,e))}if(!l||r.length||a.length||!i.length){if(r.length&&(null===(h=null===(c=this._loggerManager)||void 0===c?void 0:c.info)||void 0===h||h.call(c,t.MESSAGES.AUDIENCE_MATCH),null===(S=null===(_=this._loggerManager)||void 0===_?void 0:_.debug)||void 0===S||S.call(_,{visitorProperties:l})),a.length&&(null===(E=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===E||E.call(M,t.MESSAGES.SEGMENTATION_MATCH)),(null==D?void 0:D.variations)&&(null===(y=null==D?void 0:D.variations)||void 0===y?void 0:y.length))return D;null===(I=null===(f=this._loggerManager)||void 0===f?void 0:f.debug)||void 0===I||I.call(f,t.MESSAGES.VARIATIONS_NOT_FOUND,{visitorProperties:l,audiences:i})}else null===(p=null===(m=this._loggerManager)||void 0===m?void 0:m.debug)||void 0===p||p.call(m,t.MESSAGES.RULES_NOT_MATCH,{visitorProperties:l,audiences:i})}else null===(T=null===(O=this._loggerManager)||void 0===O?void 0:O.debug)||void 0===T||T.call(O,t.MESSAGES.LOCATION_NOT_MATCH,{locationProperties:n,[(null==D?void 0:D.locations)?"experiences[].variations[].locations":"experiences[].variations[].site_area"]:(null==D?void 0:D.locations)||(null==D?void 0:D.site_area)||""})}else null===(A=null===(b=this._loggerManager)||void 0===b?void 0:b.debug)||void 0===A||A.call(b,t.MESSAGES.EXPERIENCE_NOT_FOUND,{identity:i,identityField:r});return null}_getBucketingByField(e,i,l,n,r="key",a=this._environment){var o,s;null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.trace)||void 0===s||s.call(o,"DataManager._getBucketingByField()",{visitorId:e,identity:i,visitorProperties:l,locationProperties:n,identityField:r,environment:a});const d=this.matchRulesByField(e,i,l,n,r,a);return d?Object.values(t.RuleError).includes(d)?d:this._retrieveBucketing(e,d):null}_retrieveBucketing(e,i){var l,n,r,a,o,s,d,u,g,v,c,h,_,S,M,E;if(!e||!i)return null;if(!(null==i?void 0:i.id))return null;let y=null,f=null;const I=this.getStoreKey(e),{bucketing:m,locations:p,segments:O}=this.getLocalStore(e)||{},{[i.id.toString()]:T}=m||{};if(T&&(y=this.retrieveVariation(i.id,T)))null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.info)||void 0===n||n.call(l,t.MESSAGES.BUCKETED_VISITOR_FOUND),null===(a=null===(r=this._loggerManager)||void 0===r?void 0:r.debug)||void 0===a||a.call(r,{storeKey:I,visitorId:e,variationId:T});else{let{bucketing:{[i.id.toString()]:l}={}}=(null===(s=null===(o=this.dataStoreManager)||void 0===o?void 0:o.get)||void 0===s?void 0:s.call(o,I))||{};if(l&&(y=this.retrieveVariation(i.id,l)))this.putLocalStore(e,Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},m),{[i.id.toString()]:l})},p?{locations:p}:{}),O?{segments:O}:{})),null===(u=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===u||u.call(d,t.MESSAGES.BUCKETED_VISITOR_FOUND),null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.debug)||void 0===v||v.call(g,{storeKey:I,visitorId:e,variationId:l});else{const n=i.variations.reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{});if(l=this._bucketingManager.getBucketForVisitor(n,e),l){null===(h=null===(c=this._loggerManager)||void 0===c?void 0:c.info)||void 0===h||h.call(c,t.MESSAGES.BUCKETED_VISITOR);const n=Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},m),{[i.id.toString()]:l})},p?{locations:p}:{}),O?{segments:O}:{});this.putLocalStore(e,n),this.dataStoreManager.enqueue(I,n);const r={experienceId:i.id.toString(),variationId:l.toString()},a={eventType:t.EventType.BUCKETING,data:r};this._apiManager.enqueue(e,a,O),null===(S=null===(_=this._loggerManager)||void 0===_?void 0:_.trace)||void 0===S||S.call(_,"DataManager._retrieveBucketing()",{visitorEvent:a}),y=this.retrieveVariation(i.id,l)}else null===(E=null===(M=this._loggerManager)||void 0===M?void 0:M.error)||void 0===E||E.call(M,t.ERROR_MESSAGES.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:i})}}return y&&(f=Object.assign({experienceId:null==i?void 0:i.id,experienceName:null==i?void 0:i.name,experienceKey:null==i?void 0:i.key},y)),f}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}putLocalStore(e,t){const i=this.getStoreKey(e);if(this._bucketedVisitors.set(i,t),this._bucketedVisitors.size>this._localStoreLimit)for(const[e,t]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}}getLocalStore(e){const t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(i,l,n){var r,a,o,s,d,u,g,v,c;null===(a=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===a||a.call(r,"DataManager.selectLocations()",{items:l,locationProperties:n});const h=this.getLocalStore(i)||{},{bucketing:_,locations:S=[],segments:M}=h,E=[];let y;if(e.arrayNotEmpty(l))for(let e=0,r=l.length;e<r;e++)if(null===(o=null==l?void 0:l[e])||void 0===o?void 0:o.rules)if(y=this._ruleManager.isRuleMatched(n,l[e].rules),!0!==y||S.includes(l[e].id.toString())){if(!1!==y)E.push(y);else if(!1===y&&S.includes(l[e].id.toString())){this._eventManager.fire(t.SystemEvents.LOCATION_DEACTIVATED,{visitorId:i,location:{id:l[e].id,key:l[e].key,name:l[e].name}},null,!0);const n=S.findIndex((t=>t===l[e].id.toString()));S.splice(n,1),null===(g=null===(u=this._loggerManager)||void 0===u?void 0:u.info)||void 0===g||g.call(u,t.MESSAGES.LOCATION_INACTIVE)}}else S.push(l[e].id.toString()),this._eventManager.fire(t.SystemEvents.LOCATION_ACTIVATED,{visitorId:i,location:{id:l[e].id,key:l[e].key,name:l[e].name}},null,!0),E.push(l[e]),null===(d=null===(s=this._loggerManager)||void 0===s?void 0:s.info)||void 0===d||d.call(s,t.MESSAGES.LOCATION_ACTIVE);return this.putLocalStore(i,Object.assign(Object.assign(Object.assign({},_?{bucketing:_}:{}),{locations:S}),M?{segments:M}:{})),null===(c=null===(v=this._loggerManager)||void 0===v?void 0:v.debug)||void 0===c||c.call(v,"DataManager.selectLocations()",{matchedRecords:E}),E}getBucketing(e,t,i,l,n=this._environment){return this._getBucketingByField(e,t,i,l,"key",n)}getBucketingById(e,t,i,l,n=this._environment){return this._getBucketingByField(e,t,i,l,"id",n)}convert(e,i,l,n,r){var a,o,s,d,u,g;const v="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(!(null==v?void 0:v.id))return void(null===(o=null===(a=this._loggerManager)||void 0===a?void 0:a.error)||void 0===o||o.call(a,t.MESSAGES.GOAL_NOT_FOUND));if(l){if(!(null==v?void 0:v.rules))return;const e=this._ruleManager.isRuleMatched(l,v.rules);if(Object.values(t.RuleError).includes(e))return e;if(!e)return void(null===(d=null===(s=this._loggerManager)||void 0===s?void 0:s.error)||void 0===d||d.call(s,t.MESSAGES.GOAL_RULE_NOT_MATCH))}const c={goalId:v.id},{bucketing:h}=this.getLocalStore(e)||{};h&&(c.bucketingData=h);const _={eventType:t.EventType.CONVERSION,data:c};if(this._apiManager.enqueue(e,_,r),n){const i={goalId:v.id,goalData:n};h&&(i.bucketingData=h);const l={eventType:t.EventType.CONVERSION,data:i};this._apiManager.enqueue(e,l,r)}null===(g=null===(u=this._loggerManager)||void 0===u?void 0:u.trace)||void 0===g||g.call(u,"DataManager.convert()",{event:_})}filterMatchedRecordsWithRule(t,i){var l,n,r,a,o;null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===n||n.call(l,"DataManager.filterMatchedRecordsWithRule()",{items:t,visitorProperties:i});const s=[];let d;if(e.arrayNotEmpty(t))for(let e=0,l=t.length;e<l;e++)(null===(r=null==t?void 0:t[e])||void 0===r?void 0:r.rules)&&(d=this._ruleManager.isRuleMatched(i,t[e].rules),!0===d?s.push(t[e]):!1!==d&&s.push(d));return null===(o=null===(a=this._loggerManager)||void 0===a?void 0:a.debug)||void 0===o||o.call(a,"DataManager.filterMatchedRecordsWithRule()",{matchedRecords:s}),s}filterMatchedCustomSegments(i,l){var n,r,a,o,s;null===(r=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===r||r.call(n,"DataManager.filterMatchedCustomSegments()",{items:i,visitorId:l});const d=this.getLocalStore(l)||{},{segments:{[t.SegmentsKeys.CUSTOM_SEGMENTS]:u=[]}={}}=d,g=[];if(e.arrayNotEmpty(i))for(let e=0,t=i.length;e<t;e++)(null===(a=null==i?void 0:i[e])||void 0===a?void 0:a.id)&&u.includes(i[e].id)&&g.push(i[e]);return null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.debug)||void 0===s||s.call(o,"DataManager.filterMatchedCustomSegments()",{matchedRecords:g}),g}getEntitiesList(t){var i,l;let n=[];return-1!==this._dataEntities.indexOf(t)&&(n=e.objectDeepValue(this._data,t)||[]),null===(l=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===l||l.call(i,"DataManager.getEntitiesList()",{entityType:t,list:n}),n}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(t,i,l="key"){var n,r,a;null===(r=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===r||r.call(n,"DataManager._getEntityByField()",{identity:t,entityType:i,identityField:l});const o=this.getEntitiesList(i);if(e.arrayNotEmpty(o))for(let e=0,i=o.length;e<i;e++)if(o[e]&&String(null===(a=o[e])||void 0===a?void 0:a[l])===String(t))return o[e];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(t,i){var l;const n=this.getEntitiesList(i),r=[];if(e.arrayNotEmpty(n))for(let e=0,i=n.length;e<i;e++)-1!==t.indexOf(null===(l=n[e])||void 0===l?void 0:l.key)&&r.push(n[e]);return r}getItemsByIds(t,i){var l,n,r,a;null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===n||n.call(l,"DataManager.getItemsByIds()",{ids:t,path:i});const o=[];if(e.arrayNotEmpty(t)){const l=this.getEntitiesList(i);if(e.arrayNotEmpty(l))for(let e=0,i=l.length;e<i;e++)-1===t.indexOf(Number(null===(r=l[e])||void 0===r?void 0:r.id))&&-1===t.indexOf(String(null===(a=l[e])||void 0===a?void 0:a.id))||o.push(l[e])}return o}getSubItem(e,t,i,l,n,r){var a;const o=this._getEntityByField(t,e,n);for(const e in o[i])if(String(null===(a=o[i][e])||void 0===a?void 0:a[r])===String(l))return o[i][e];return null}isValidConfigData(t){var i;return e.objectNotEmpty(t)&&!!(null==t?void 0:t.account_id)&&!!(null===(i=null==t?void 0:t.project)||void 0===i?void 0:i.id)}},exports.DataStoreManager=i;
//# sourceMappingURL=index.min.js.map
