/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/js-sdk-utils"),t=require("@convertcom/js-sdk-enums");class i{constructor(e,{dataStore:t,eventManager:i,loggerManager:n}={}){this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=n,this._eventManager=i,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=t,this._requestsQueue={}}set(e,t){var i,n;try{null===(n=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===n||n.call(i,e,t)}catch(e){}}get(e){var t,i;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){}return null}enqueue(t,i){const n={};n[t]=i,this._requestsQueue=e.objectDeepMerge(this._requestsQueue,n),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var i,n;this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(n=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===n||n.call(i,t.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){e&&this.isValidDataStore(e)&&(this._dataStore=e)}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}exports.DataManager=class{constructor(i,{bucketingManager:n,ruleManager:s,eventManager:r,apiManager:a,loggerManager:o}){var l,u,d;this._dataEntities=t.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=a,this._bucketingManager=n,this._ruleManager=s,this._loggerManager=o,this._eventManager=r,this._config=i,this._data=e.objectDeepValue(i,"data"),this._accountId=null===(l=this._data)||void 0===l?void 0:l.account_id,this._projectId=null===(d=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===d?void 0:d.id,this.dataStoreManager=e.objectDeepValue(i,"dataStore")}set data(e){var t;this.isValidConfigData(e)&&(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,this._dataStoreManager=new i(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})}get dataStoreManager(){return this._dataStoreManager}matchRulesByField(e,i,n,s,r="key",a=this._environment){var o;const l=this._getEntityByField(i,"experiences",r),u=!!this.getEntitiesList("archived_experiences").find((e=>String(null==l?void 0:l.id)===String(e))),d=!Array.isArray(null==l?void 0:l.environments)||(!l.environments.length||l.environments.includes(a)),c=this.getLocalStore(e)||{},{locations:g=[]}=c;let h=[];if(l&&!u&&d){let i=!1,r=[];if(s)if(Array.isArray(null==l?void 0:l.locations)&&l.locations.length){if(r=l.locations.filter((e=>g.includes(e.toString()))),!r.length){const e=this.getItemsByIds(l.locations,"locations");if(e.length&&(r=this.filterMatchedRecordsWithRule(e,s),h=r.filter((e=>Object.values(t.RuleError).includes(e))),h.length))return h[0]}i=Boolean(r.length)}else if(null==l?void 0:l.site_area){if(i=this._ruleManager.isRuleMatched(s,l.site_area),Object.values(t.RuleError).includes(i))return i}else i=!0;if(!s||i){let i=[],s=[],r=[],a=[];if(n&&Array.isArray(null==l?void 0:l.audiences)&&l.audiences.length){if(i=this.getItemsByIds(l.audiences,"audiences"),i.length&&(r=this.filterMatchedRecordsWithRule(i,n),h=r.filter((e=>Object.values(t.RuleError).includes(e))),h.length))return h[0];s=this.getItemsByIds(l.audiences,"segments"),s.length&&(a=this.filterMatchedCustomSegments(s,e))}if((!n||r.length||a.length||!i.length)&&(null==l?void 0:l.variations)&&(null===(o=null==l?void 0:l.variations)||void 0===o?void 0:o.length))return l}}return null}_getBucketingByField(e,i,n,s,r="key",a=this._environment){const o=this.matchRulesByField(e,i,n,s,r,a);return o?Object.values(t.RuleError).includes(o)?o:this._retrieveBucketing(e,o):null}_retrieveBucketing(e,i){var n,s;if(!e||!i)return null;if(!(null==i?void 0:i.id))return null;let r=null,a=null;const o=this.getStoreKey(e),{bucketing:l,locations:u,segments:d}=this.getLocalStore(e)||{},{[i.id.toString()]:c}=l||{};if(c&&(r=this.retrieveVariation(i.id,c)));else{let{bucketing:{[i.id.toString()]:a}={}}=(null===(s=null===(n=this.dataStoreManager)||void 0===n?void 0:n.get)||void 0===s?void 0:s.call(n,o))||{};if(a&&(r=this.retrieveVariation(i.id,a)))this.putLocalStore(e,Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},l),{[i.id.toString()]:a})},u?{locations:u}:{}),d?{segments:d}:{}));else{const n=i.variations.reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{});if(a=this._bucketingManager.getBucketForVisitor(n,e),a){const n=Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},l),{[i.id.toString()]:a})},u?{locations:u}:{}),d?{segments:d}:{});this.putLocalStore(e,n),this.dataStoreManager.enqueue(o,n);const s={experienceId:i.id.toString(),variationId:a.toString()},c={eventType:t.EventType.BUCKETING,data:s};this._apiManager.enqueue(e,c,d),r=this.retrieveVariation(i.id,a)}}}return r&&(a=Object.assign({experienceId:null==i?void 0:i.id,experienceName:null==i?void 0:i.name,experienceKey:null==i?void 0:i.key},r)),a}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}putLocalStore(e,t){const i=this.getStoreKey(e);if(this._bucketedVisitors.set(i,t),this._bucketedVisitors.size>this._localStoreLimit)for(const[e,t]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}}getLocalStore(e){const t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(i,n,s){var r;const a=this.getLocalStore(i)||{},{bucketing:o,locations:l=[],segments:u}=a,d=[];let c;if(e.arrayNotEmpty(n))for(let e=0,a=n.length;e<a;e++)if(null===(r=null==n?void 0:n[e])||void 0===r?void 0:r.rules)if(c=this._ruleManager.isRuleMatched(s,n[e].rules),!0!==c||l.includes(n[e].id.toString())){if(!1!==c)d.push(c);else if(!1===c&&l.includes(n[e].id.toString())){this._eventManager.fire(t.SystemEvents.LOCATION_DEACTIVATED,{visitorId:i,location:{id:n[e].id,key:n[e].key,name:n[e].name}},null,!0);const s=l.findIndex((t=>t===n[e].id.toString()));l.splice(s,1)}}else l.push(n[e].id.toString()),this._eventManager.fire(t.SystemEvents.LOCATION_ACTIVATED,{visitorId:i,location:{id:n[e].id,key:n[e].key,name:n[e].name}},null,!0),d.push(n[e]);return this.putLocalStore(i,Object.assign(Object.assign(Object.assign({},o?{bucketing:o}:{}),{locations:l}),u?{segments:u}:{})),d}getBucketing(e,t,i,n,s=this._environment){return this._getBucketingByField(e,t,i,n,"key",s)}getBucketingById(e,t,i,n,s=this._environment){return this._getBucketingByField(e,t,i,n,"id",s)}convert(e,i,n,s,r){const a="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(!(null==a?void 0:a.id))return;if(n){if(!(null==a?void 0:a.rules))return;const e=this._ruleManager.isRuleMatched(n,a.rules);if(Object.values(t.RuleError).includes(e))return e;if(!e)return}const o={goalId:a.id},{bucketing:l}=this.getLocalStore(e)||{};l&&(o.bucketingData=l);const u={eventType:t.EventType.CONVERSION,data:o};if(this._apiManager.enqueue(e,u,r),s){const i={goalId:a.id,goalData:s};l&&(i.bucketingData=l);const n={eventType:t.EventType.CONVERSION,data:i};this._apiManager.enqueue(e,n,r)}}filterMatchedRecordsWithRule(t,i){var n;const s=[];let r;if(e.arrayNotEmpty(t))for(let e=0,a=t.length;e<a;e++)(null===(n=null==t?void 0:t[e])||void 0===n?void 0:n.rules)&&(r=this._ruleManager.isRuleMatched(i,t[e].rules),!0===r?s.push(t[e]):!1!==r&&s.push(r));return s}filterMatchedCustomSegments(i,n){var s;const r=this.getLocalStore(n)||{},{segments:{[t.SegmentsKeys.CUSTOM_SEGMENTS]:a=[]}={}}=r,o=[];if(e.arrayNotEmpty(i))for(let e=0,t=i.length;e<t;e++)(null===(s=null==i?void 0:i[e])||void 0===s?void 0:s.id)&&a.includes(i[e].id)&&o.push(i[e]);return o}getEntitiesList(t){let i=[];return-1!==this._dataEntities.indexOf(t)&&(i=e.objectDeepValue(this._data,t)||[]),i}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(t,i,n="key"){var s;const r=this.getEntitiesList(i);if(e.arrayNotEmpty(r))for(let e=0,i=r.length;e<i;e++)if(r[e]&&String(null===(s=r[e])||void 0===s?void 0:s[n])===String(t))return r[e];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(t,i){var n;const s=this.getEntitiesList(i),r=[];if(e.arrayNotEmpty(s))for(let e=0,i=s.length;e<i;e++)-1!==t.indexOf(null===(n=s[e])||void 0===n?void 0:n.key)&&r.push(s[e]);return r}getItemsByIds(t,i){var n,s;const r=[];if(e.arrayNotEmpty(t)){const a=this.getEntitiesList(i);if(e.arrayNotEmpty(a))for(let e=0,i=a.length;e<i;e++)-1===t.indexOf(Number(null===(n=a[e])||void 0===n?void 0:n.id))&&-1===t.indexOf(String(null===(s=a[e])||void 0===s?void 0:s.id))||r.push(a[e])}return r}getSubItem(e,t,i,n,s,r){var a;const o=this._getEntityByField(t,e,s);for(const e in o[i])if(String(null===(a=o[i][e])||void 0===a?void 0:a[r])===String(n))return o[i][e];return null}isValidConfigData(t){var i;return e.objectNotEmpty(t)&&!!(null==t?void 0:t.account_id)&&!!(null===(i=null==t?void 0:t.project)||void 0===i?void 0:i.id)}},exports.DataStoreManager=i;
//# sourceMappingURL=index.min.js.map
