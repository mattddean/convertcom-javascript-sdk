/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/js-sdk-utils"),t=require("@convertcom/js-sdk-enums");class i{constructor(e,{dataStore:t,eventManager:i,loggerManager:n}={}){this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=n,this._eventManager=i,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=t,this._requestsQueue={}}set(e,t){var i,n,l,r;try{null===(n=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===n||n.call(i,e,t)}catch(e){null===(r=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===r||r.call(l,"DataStoreManager.set()",{error:e.message})}}get(e){var t,i,n,l;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(l=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===l||l.call(n,"DataStoreManager.get()",{error:e.message})}return null}enqueue(t,i){const n={};n[t]=i,this._requestsQueue=e.objectDeepMerge(this._requestsQueue,n),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var i,n;this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(n=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===n||n.call(i,t.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){var i,n;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===n||n.call(i,t.ERROR_MESSAGES.DATA_STORE_NOT_VALID))}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}exports.DataManager=class{constructor(i,{bucketingManager:n,ruleManager:l,eventManager:r,apiManager:o,loggerManager:a}){var s,u,d;this._dataEntities=t.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=o,this._bucketingManager=n,this._ruleManager=l,this._loggerManager=a,this._eventManager=r,this._config=i,this._data=e.objectDeepValue(i,"data"),this._accountId=null===(s=this._data)||void 0===s?void 0:s.account_id,this._projectId=null===(d=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===d?void 0:d.id,this.dataStoreManager=e.objectDeepValue(i,"dataStore")}set data(e){var i,n,l;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(i=null==e?void 0:e.project)||void 0===i?void 0:i.id):null===(l=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===l||l.call(n,t.ERROR_MESSAGES.CONFIG_DATA_NOT_VALID)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,this._dataStoreManager=new i(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})}get dataStoreManager(){return this._dataStoreManager}matchRulesByField(e,i,n,l,r="key",o=this._environment){var a,s,u,d,g,c,v,h,_,S,E,M,f,y,I,O,p;const A=this._getEntityByField(i,"experiences",r),T=!!this.getEntitiesList("archived_experiences").find((e=>String(null==A?void 0:A.id)===String(e))),m=!Array.isArray(null==A?void 0:A.environments)||(!A.environments.length||A.environments.includes(o));let b=[];if(A&&!T&&m){let i=!1,o=[];if(l)if(Array.isArray(null==A?void 0:A.locations)&&A.locations.length){const n=this.getItemsByIds(A.locations,"locations");if(n.length&&(o=this.selectLocations(e,n,l,r),b=o.filter((e=>Object.values(t.RuleError).includes(e))),b.length))return b[0];i=Boolean(o.length)}else if(null==A?void 0:A.site_area){if(i=this._ruleManager.isRuleMatched(l,A.site_area,"SiteArea"),Object.values(t.RuleError).includes(i))return i}else i=!0;if(!l||i){let i=[],l=[],o=[],y=[];if(n)if(Array.isArray(null==A?void 0:A.audiences)&&A.audiences.length){if(i=this.getItemsByIds(A.audiences,"audiences"),i.length){if(o=this.filterMatchedRecordsWithRule(i,n,"audience",r),b=o.filter((e=>Object.values(t.RuleError).includes(e))),b.length)return b[0];if(o.length)for(const e of o)null===(s=null===(a=this._loggerManager)||void 0===a?void 0:a.info)||void 0===s||s.call(a,t.MESSAGES.AUDIENCE_MATCH.replace("#",null==e?void 0:e[r]))}if(l=this.getItemsByIds(A.audiences,"segments"),l.length&&(y=this.filterMatchedCustomSegments(l,e),y.length))for(const e of y)null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.info)||void 0===d||d.call(u,t.MESSAGES.SEGMENTATION_MATCH.replace("#",null==e?void 0:e[r]))}else null===(c=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===c||c.call(g,t.MESSAGES.AUDIENCE_NOT_RESTRICTED);if(!n||o.length||y.length||!i.length){if((null==A?void 0:A.variations)&&(null===(v=null==A?void 0:A.variations)||void 0===v?void 0:v.length))return null===(_=null===(h=this._loggerManager)||void 0===h?void 0:h.info)||void 0===_||_.call(h,t.MESSAGES.EXPERIENCE_RULES_MATCHED),A;null===(E=null===(S=this._loggerManager)||void 0===S?void 0:S.info)||void 0===E||E.call(S,t.MESSAGES.VARIATIONS_NOT_FOUND)}else null===(f=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===f||f.call(M,t.MESSAGES.AUDIENCE_NOT_MATCH)}else null===(I=null===(y=this._loggerManager)||void 0===y?void 0:y.info)||void 0===I||I.call(y,t.MESSAGES.LOCATION_NOT_MATCH)}else null===(p=null===(O=this._loggerManager)||void 0===O?void 0:O.info)||void 0===p||p.call(O,t.MESSAGES.EXPERIENCE_NOT_FOUND);return null}_getBucketingByField(e,i,n,l,r="key",o=this._environment){const a=this.matchRulesByField(e,i,n,l,r,o);return a?Object.values(t.RuleError).includes(a)?a:this._retrieveBucketing(e,a):null}_retrieveBucketing(e,i){var n,l,r,o,a,s,u,d,g,c;if(!e||!i)return null;if(!(null==i?void 0:i.id))return null;let v=null,h=null;const _=this.getStoreKey(e),{bucketing:S,locations:E,segments:M}=this.getLocalStore(e)||{},{[i.id.toString()]:f}=S||{};if(f&&(v=this.retrieveVariation(i.id,f)))null===(l=null===(n=this._loggerManager)||void 0===n?void 0:n.info)||void 0===l||l.call(n,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#",`#${f}`));else{let{bucketing:{[i.id.toString()]:n}={}}=(null===(o=null===(r=this.dataStoreManager)||void 0===r?void 0:r.get)||void 0===o?void 0:o.call(r,_))||{};if(n&&(v=this.retrieveVariation(i.id,n)))this.putLocalStore(e,Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},S),{[i.id.toString()]:n})},E?{locations:E}:{}),M?{segments:M}:{})),null===(s=null===(a=this._loggerManager)||void 0===a?void 0:a.info)||void 0===s||s.call(a,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#",`#${n}`));else{const l=i.variations.reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{});if(n=this._bucketingManager.getBucketForVisitor(l,e),n){null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.info)||void 0===d||d.call(u,t.MESSAGES.BUCKETED_VISITOR.replace("#",`#${n}`));const l=Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},S),{[i.id.toString()]:n})},E?{locations:E}:{}),M?{segments:M}:{});this.putLocalStore(e,l),this.dataStoreManager.enqueue(_,l);const r={experienceId:i.id.toString(),variationId:n.toString()},o={eventType:t.EventType.BUCKETING,data:r};this._apiManager.enqueue(e,o,M),v=this.retrieveVariation(i.id,n)}else null===(c=null===(g=this._loggerManager)||void 0===g?void 0:g.error)||void 0===c||c.call(g,t.ERROR_MESSAGES.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:i})}}return v&&(h=Object.assign({experienceId:null==i?void 0:i.id,experienceName:null==i?void 0:i.name,experienceKey:null==i?void 0:i.key},v)),h}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}putLocalStore(e,t){const i=this.getStoreKey(e);if(this._bucketedVisitors.set(i,t),this._bucketedVisitors.size>this._localStoreLimit)for(const[e,t]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}}getLocalStore(e){const t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(i,n,l,r="key"){var o,a,s,u,d,g,c,v,h,_,S,E,M,f,y,I;const O=this.getLocalStore(i)||{},{bucketing:p,locations:A=[],segments:T}=O,m=[];let b;if(e.arrayNotEmpty(n))for(let e=0,O=n.length;e<O;e++){if(!(null===(o=null==n?void 0:n[e])||void 0===o?void 0:o.rules))continue;b=this._ruleManager.isRuleMatched(l,n[e].rules,`Location #${n[e][r]}`);const O=null===(u=null===(s=null===(a=null==n?void 0:n[e])||void 0===a?void 0:a[r])||void 0===s?void 0:s.toString)||void 0===u?void 0:u.call(s);if(!0===b)null===(g=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===g||g.call(d,t.MESSAGES.LOCATION_MATCH.replace("#",`#${O}`)),A.includes(O)||(A.push(O),this._eventManager.fire(t.SystemEvents.LOCATION_ACTIVATED,{visitorId:i,location:{id:null===(c=null==n?void 0:n[e])||void 0===c?void 0:c.id,key:null===(v=null==n?void 0:n[e])||void 0===v?void 0:v.key,name:null===(h=null==n?void 0:n[e])||void 0===h?void 0:h.name}},null,!0),null===(S=null===(_=this._loggerManager)||void 0===_?void 0:_.info)||void 0===S||S.call(_,t.MESSAGES.LOCATION_ACTIVATED.replace("#",`#${O}`))),m.push(n[e]);else if(!1!==b)m.push(b);else if(!1===b&&A.includes(O)){this._eventManager.fire(t.SystemEvents.LOCATION_DEACTIVATED,{visitorId:i,location:{id:null===(E=null==n?void 0:n[e])||void 0===E?void 0:E.id,key:null===(M=null==n?void 0:n[e])||void 0===M?void 0:M.key,name:null===(f=null==n?void 0:n[e])||void 0===f?void 0:f.name}},null,!0);const l=A.findIndex((e=>e===O));A.splice(l,1),null===(I=null===(y=this._loggerManager)||void 0===y?void 0:y.info)||void 0===I||I.call(y,t.MESSAGES.LOCATION_DEACTIVATED.replace("#",`#${O}`))}}return this.putLocalStore(i,Object.assign(Object.assign(Object.assign({},p?{bucketing:p}:{}),{locations:A}),T?{segments:T}:{})),m}getBucketing(e,t,i,n,l=this._environment){return this._getBucketingByField(e,t,i,n,"key",l)}getBucketingById(e,t,i,n,l=this._environment){return this._getBucketingByField(e,t,i,n,"id",l)}convert(e,i,n,l,r){var o,a,s,u;const d="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(!(null==d?void 0:d.id))return void(null===(a=null===(o=this._loggerManager)||void 0===o?void 0:o.error)||void 0===a||a.call(o,t.MESSAGES.GOAL_NOT_FOUND));if(n){if(!(null==d?void 0:d.rules))return;const e=this._ruleManager.isRuleMatched(n,d.rules,`Goal #${i}`);if(Object.values(t.RuleError).includes(e))return e;if(!e)return void(null===(u=null===(s=this._loggerManager)||void 0===s?void 0:s.error)||void 0===u||u.call(s,t.MESSAGES.GOAL_RULE_NOT_MATCH))}const g={goalId:d.id},{bucketing:c}=this.getLocalStore(e)||{};c&&(g.bucketingData=c);const v={eventType:t.EventType.CONVERSION,data:g};if(this._apiManager.enqueue(e,v,r),l){const i={goalId:d.id,goalData:l};c&&(i.bucketingData=c);const n={eventType:t.EventType.CONVERSION,data:i};this._apiManager.enqueue(e,n,r)}}filterMatchedRecordsWithRule(t,i,n,l="id"){var r;const o=[];let a;if(e.arrayNotEmpty(t))for(let s=0,u=t.length;s<u;s++)(null===(r=null==t?void 0:t[s])||void 0===r?void 0:r.rules)&&(a=this._ruleManager.isRuleMatched(i,t[s].rules,`${e.camelCase(n)} #${t[s][l]}`),!0===a?o.push(t[s]):!1!==a&&o.push(a));return o}filterMatchedCustomSegments(i,n){var l;const r=this.getLocalStore(n)||{},{segments:{[t.SegmentsKeys.CUSTOM_SEGMENTS]:o=[]}={}}=r,a=[];if(e.arrayNotEmpty(i))for(let e=0,t=i.length;e<t;e++)(null===(l=null==i?void 0:i[e])||void 0===l?void 0:l.id)&&o.includes(i[e].id)&&a.push(i[e]);return a}getEntitiesList(t){let i=[];return-1!==this._dataEntities.indexOf(t)&&(i=e.objectDeepValue(this._data,t)||[]),i}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(t,i,n="key"){var l;const r=this.getEntitiesList(i);if(e.arrayNotEmpty(r))for(let e=0,i=r.length;e<i;e++)if(r[e]&&String(null===(l=r[e])||void 0===l?void 0:l[n])===String(t))return r[e];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(t,i){var n;const l=this.getEntitiesList(i),r=[];if(e.arrayNotEmpty(l))for(let e=0,i=l.length;e<i;e++)-1!==t.indexOf(null===(n=l[e])||void 0===n?void 0:n.key)&&r.push(l[e]);return r}getItemsByIds(t,i){var n,l;const r=[];if(e.arrayNotEmpty(t)){const o=this.getEntitiesList(i);if(e.arrayNotEmpty(o))for(let e=0,i=o.length;e<i;e++)-1===t.indexOf(Number(null===(n=o[e])||void 0===n?void 0:n.id))&&-1===t.indexOf(String(null===(l=o[e])||void 0===l?void 0:l.id))||r.push(o[e])}return r}getSubItem(e,t,i,n,l,r){var o;const a=this._getEntityByField(t,e,l);for(const e in a[i])if(String(null===(o=a[i][e])||void 0===o?void 0:o[r])===String(n))return a[i][e];return null}isValidConfigData(t){var i;return e.objectNotEmpty(t)&&!!(null==t?void 0:t.account_id)&&!!(null===(i=null==t?void 0:t.project)||void 0===i?void 0:i.id)}},exports.DataStoreManager=i;
//# sourceMappingURL=index.min.js.map
