/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
import{objectDeepMerge as e,objectDeepValue as t,arrayNotEmpty as i,camelCase as n,objectNotEmpty as l}from"@convertcom/js-sdk-utils";import{SystemEvents as o,ERROR_MESSAGES as r,DATA_ENTITIES as s,RuleError as a,MESSAGES as u,EventType as d,SegmentsKeys as g}from"@convertcom/js-sdk-enums";class c{constructor(e,{dataStore:t,eventManager:i,loggerManager:n}={}){this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=n,this._eventManager=i,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=t,this._requestsQueue={}}set(e,t){var i,n,l,o;try{null===(n=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===n||n.call(i,e,t)}catch(e){null===(o=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===o||o.call(l,"DataStoreManager.set()",{error:e.message})}}get(e){var t,i,n,l;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(l=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===l||l.call(n,"DataStoreManager.get()",{error:e.message})}return null}enqueue(t,i){const n={};n[t]=i,this._requestsQueue=e(this._requestsQueue,n),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var t,i;this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(i=null===(t=this._eventManager)||void 0===t?void 0:t.fire)||void 0===i||i.call(t,o.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){var t,i;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,r.DATA_STORE_NOT_VALID))}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}class v{constructor(e,{bucketingManager:i,ruleManager:n,eventManager:l,apiManager:o,loggerManager:r}){var a,u,d;this._dataEntities=s,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==e?void 0:e.environment,this._apiManager=o,this._bucketingManager=i,this._ruleManager=n,this._loggerManager=r,this._eventManager=l,this._config=e,this._data=t(e,"data"),this._accountId=null===(a=this._data)||void 0===a?void 0:a.account_id,this._projectId=null===(d=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===d?void 0:d.id,this.dataStoreManager=t(e,"dataStore")}set data(e){var t,i,n;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id):null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===n||n.call(i,r.CONFIG_DATA_NOT_VALID)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,this._dataStoreManager=new c(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})}get dataStoreManager(){return this._dataStoreManager}matchRulesByField(e,t,i,n,l="key",o=this._environment){var r,s,d,g,c,v,h,_,f,M,S,I,E,O,y,T,m;const p=this._getEntityByField(t,"experiences",l),b=!!this.getEntitiesList("archived_experiences").find((e=>String(null==p?void 0:p.id)===String(e))),A=!Array.isArray(null==p?void 0:p.environments)||(!p.environments.length||p.environments.includes(o));let k=[];if(p&&!b&&A){let t=!1,o=[];if(n)if(Array.isArray(null==p?void 0:p.locations)&&p.locations.length){const i=this.getItemsByIds(p.locations,"locations");if(i.length&&(o=this.selectLocations(e,i,n,l),k=o.filter((e=>Object.values(a).includes(e))),k.length))return k[0];t=Boolean(o.length)}else if(null==p?void 0:p.site_area){if(t=this._ruleManager.isRuleMatched(n,p.site_area,"SiteArea"),Object.values(a).includes(t))return t}else t=!0;if(!n||t){let t=[],n=[],o=[],O=[];if(i)if(Array.isArray(null==p?void 0:p.audiences)&&p.audiences.length){if(t=this.getItemsByIds(p.audiences,"audiences"),t.length){if(o=this.filterMatchedRecordsWithRule(t,i,"audience",l),k=o.filter((e=>Object.values(a).includes(e))),k.length)return k[0];if(o.length)for(const e of o)null===(s=null===(r=this._loggerManager)||void 0===r?void 0:r.info)||void 0===s||s.call(r,u.AUDIENCE_MATCH.replace("#",null==e?void 0:e[l]))}if(n=this.getItemsByIds(p.audiences,"segments"),n.length&&(O=this.filterMatchedCustomSegments(n,e),O.length))for(const e of O)null===(g=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===g||g.call(d,u.SEGMENTATION_MATCH.replace("#",null==e?void 0:e[l]))}else null===(v=null===(c=this._loggerManager)||void 0===c?void 0:c.info)||void 0===v||v.call(c,u.AUDIENCE_NOT_RESTRICTED);if(!i||o.length||O.length||!t.length){if((null==p?void 0:p.variations)&&(null===(h=null==p?void 0:p.variations)||void 0===h?void 0:h.length))return null===(f=null===(_=this._loggerManager)||void 0===_?void 0:_.info)||void 0===f||f.call(_,u.EXPERIENCE_RULES_MATCHED),p;null===(S=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===S||S.call(M,u.VARIATIONS_NOT_FOUND)}else null===(E=null===(I=this._loggerManager)||void 0===I?void 0:I.info)||void 0===E||E.call(I,u.AUDIENCE_NOT_MATCH)}else null===(y=null===(O=this._loggerManager)||void 0===O?void 0:O.info)||void 0===y||y.call(O,u.LOCATION_NOT_MATCH)}else null===(m=null===(T=this._loggerManager)||void 0===T?void 0:T.info)||void 0===m||m.call(T,u.EXPERIENCE_NOT_FOUND);return null}_getBucketingByField(e,t,i,n,l="key",o=this._environment){const r=this.matchRulesByField(e,t,i,n,l,o);return r?Object.values(a).includes(r)?r:this._retrieveBucketing(e,r):null}_retrieveBucketing(e,t){var i,n,l,o,s,a,g,c,v,h;if(!e||!t)return null;if(!(null==t?void 0:t.id))return null;let _=null,f=null;const M=this.getStoreKey(e),{bucketing:S,locations:I,segments:E}=this.getLocalStore(e)||{},{[t.id.toString()]:O}=S||{};if(O&&(_=this.retrieveVariation(t.id,O)))null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.info)||void 0===n||n.call(i,u.BUCKETED_VISITOR_FOUND.replace("#",`#${O}`));else{let{bucketing:{[t.id.toString()]:i}={}}=(null===(o=null===(l=this.dataStoreManager)||void 0===l?void 0:l.get)||void 0===o?void 0:o.call(l,M))||{};if(i&&(_=this.retrieveVariation(t.id,i)))this.putLocalStore(e,Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},S),{[t.id.toString()]:i})},I?{locations:I}:{}),E?{segments:E}:{})),null===(a=null===(s=this._loggerManager)||void 0===s?void 0:s.info)||void 0===a||a.call(s,u.BUCKETED_VISITOR_FOUND.replace("#",`#${i}`));else{const n=t.variations.reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{});if(i=this._bucketingManager.getBucketForVisitor(n,e),i){null===(c=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===c||c.call(g,u.BUCKETED_VISITOR.replace("#",`#${i}`));const n=Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},S),{[t.id.toString()]:i})},I?{locations:I}:{}),E?{segments:E}:{});this.putLocalStore(e,n),this.dataStoreManager.enqueue(M,n);const l={experienceId:t.id.toString(),variationId:i.toString()},o={eventType:d.BUCKETING,data:l};this._apiManager.enqueue(e,o,E),_=this.retrieveVariation(t.id,i)}else null===(h=null===(v=this._loggerManager)||void 0===v?void 0:v.error)||void 0===h||h.call(v,r.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:t})}}return _&&(f=Object.assign({experienceId:null==t?void 0:t.id,experienceName:null==t?void 0:t.name,experienceKey:null==t?void 0:t.key},_)),f}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}putLocalStore(e,t){const i=this.getStoreKey(e);if(this._bucketedVisitors.set(i,t),this._bucketedVisitors.size>this._localStoreLimit)for(const[e,t]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}}getLocalStore(e){const t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(e,t,n,l="key"){var r,s,a,d,g,c,v,h,_,f,M,S,I,E,O,y;const T=this.getLocalStore(e)||{},{bucketing:m,locations:p=[],segments:b}=T,A=[];let k;if(i(t))for(let i=0,T=t.length;i<T;i++){if(!(null===(r=null==t?void 0:t[i])||void 0===r?void 0:r.rules))continue;k=this._ruleManager.isRuleMatched(n,t[i].rules,`Location #${t[i][l]}`);const T=null===(d=null===(a=null===(s=null==t?void 0:t[i])||void 0===s?void 0:s[l])||void 0===a?void 0:a.toString)||void 0===d?void 0:d.call(a);if(!0===k)null===(c=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===c||c.call(g,u.LOCATION_MATCH.replace("#",`#${T}`)),p.includes(T)||(p.push(T),this._eventManager.fire(o.LOCATION_ACTIVATED,{visitorId:e,location:{id:null===(v=null==t?void 0:t[i])||void 0===v?void 0:v.id,key:null===(h=null==t?void 0:t[i])||void 0===h?void 0:h.key,name:null===(_=null==t?void 0:t[i])||void 0===_?void 0:_.name}},null,!0),null===(M=null===(f=this._loggerManager)||void 0===f?void 0:f.info)||void 0===M||M.call(f,u.LOCATION_ACTIVATED.replace("#",`#${T}`))),A.push(t[i]);else if(!1!==k)A.push(k);else if(!1===k&&p.includes(T)){this._eventManager.fire(o.LOCATION_DEACTIVATED,{visitorId:e,location:{id:null===(S=null==t?void 0:t[i])||void 0===S?void 0:S.id,key:null===(I=null==t?void 0:t[i])||void 0===I?void 0:I.key,name:null===(E=null==t?void 0:t[i])||void 0===E?void 0:E.name}},null,!0);const n=p.findIndex((e=>e===T));p.splice(n,1),null===(y=null===(O=this._loggerManager)||void 0===O?void 0:O.info)||void 0===y||y.call(O,u.LOCATION_DEACTIVATED.replace("#",`#${T}`))}}return this.putLocalStore(e,Object.assign(Object.assign(Object.assign({},m?{bucketing:m}:{}),{locations:p}),b?{segments:b}:{})),A}getBucketing(e,t,i,n,l=this._environment){return this._getBucketingByField(e,t,i,n,"key",l)}getBucketingById(e,t,i,n,l=this._environment){return this._getBucketingByField(e,t,i,n,"id",l)}convert(e,t,i,n,l){var o,r,s,g;const c="string"==typeof t?this.getEntity(t,"goals"):this.getEntityById(t,"goals");if(!(null==c?void 0:c.id))return void(null===(r=null===(o=this._loggerManager)||void 0===o?void 0:o.error)||void 0===r||r.call(o,u.GOAL_NOT_FOUND));if(i){if(!(null==c?void 0:c.rules))return;const e=this._ruleManager.isRuleMatched(i,c.rules,`Goal #${t}`);if(Object.values(a).includes(e))return e;if(!e)return void(null===(g=null===(s=this._loggerManager)||void 0===s?void 0:s.error)||void 0===g||g.call(s,u.GOAL_RULE_NOT_MATCH))}const v={goalId:c.id},{bucketing:h}=this.getLocalStore(e)||{};h&&(v.bucketingData=h);const _={eventType:d.CONVERSION,data:v};if(this._apiManager.enqueue(e,_,l),n){const t={goalId:c.id,goalData:n};h&&(t.bucketingData=h);const i={eventType:d.CONVERSION,data:t};this._apiManager.enqueue(e,i,l)}}filterMatchedRecordsWithRule(e,t,l,o="id"){var r;const s=[];let a;if(i(e))for(let i=0,u=e.length;i<u;i++)(null===(r=null==e?void 0:e[i])||void 0===r?void 0:r.rules)&&(a=this._ruleManager.isRuleMatched(t,e[i].rules,`${n(l)} #${e[i][o]}`),!0===a?s.push(e[i]):!1!==a&&s.push(a));return s}filterMatchedCustomSegments(e,t){var n;const l=this.getLocalStore(t)||{},{segments:{[g.CUSTOM_SEGMENTS]:o=[]}={}}=l,r=[];if(i(e))for(let t=0,i=e.length;t<i;t++)(null===(n=null==e?void 0:e[t])||void 0===n?void 0:n.id)&&o.includes(e[t].id)&&r.push(e[t]);return r}getEntitiesList(e){let i=[];return-1!==this._dataEntities.indexOf(e)&&(i=t(this._data,e)||[]),i}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(e,t,n="key"){var l;const o=this.getEntitiesList(t);if(i(o))for(let t=0,i=o.length;t<i;t++)if(o[t]&&String(null===(l=o[t])||void 0===l?void 0:l[n])===String(e))return o[t];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(e,t){var n;const l=this.getEntitiesList(t),o=[];if(i(l))for(let t=0,i=l.length;t<i;t++)-1!==e.indexOf(null===(n=l[t])||void 0===n?void 0:n.key)&&o.push(l[t]);return o}getItemsByIds(e,t){var n,l;const o=[];if(i(e)){const r=this.getEntitiesList(t);if(i(r))for(let t=0,i=r.length;t<i;t++)-1===e.indexOf(Number(null===(n=r[t])||void 0===n?void 0:n.id))&&-1===e.indexOf(String(null===(l=r[t])||void 0===l?void 0:l.id))||o.push(r[t])}return o}getSubItem(e,t,i,n,l,o){var r;const s=this._getEntityByField(t,e,l);for(const e in s[i])if(String(null===(r=s[i][e])||void 0===r?void 0:r[o])===String(n))return s[i][e];return null}isValidConfigData(e){var t;return l(e)&&!!(null==e?void 0:e.account_id)&&!!(null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)}}export{v as DataManager,c as DataStoreManager};
//# sourceMappingURL=index.min.mjs.map
