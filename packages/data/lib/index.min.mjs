/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
import{objectDeepMerge as e,objectDeepValue as t,arrayNotEmpty as i,objectNotEmpty as l}from"@convertcom/js-sdk-utils";import{SystemEvents as n,ERROR_MESSAGES as a,DATA_ENTITIES as r,MESSAGES as o,RuleError as s,EventType as d,SegmentsKeys as u}from"@convertcom/js-sdk-enums";class g{constructor(e,{dataStore:t,eventManager:i,loggerManager:l}={}){this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=l,this._eventManager=i,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=t,this._requestsQueue={}}set(e,t){var i,l,n,a;try{null===(l=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===l||l.call(i,e,t)}catch(e){null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===a||a.call(n,"DataStoreManager.set()",{error:e.message})}}get(e){var t,i,l,n;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===n||n.call(l,"DataStoreManager.get()",{error:e.message})}return null}enqueue(t,i){var l,n;null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===n||n.call(l,"DataStoreManager.enqueue()",{key:t,data:i});const a={};a[t]=i,this._requestsQueue=e(this._requestsQueue,a),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var t,i,l,a;null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"DataStoreManager.releaseQueue()",{reason:e||""}),this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(a=null===(l=this._eventManager)||void 0===l?void 0:l.fire)||void 0===a||a.call(l,n.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){var t,i;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,a.DATA_STORE_NOT_VALID))}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}class v{constructor(e,{bucketingManager:i,ruleManager:l,eventManager:n,apiManager:a,loggerManager:s}){var d,u,g,v,c;this._dataEntities=r,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==e?void 0:e.environment,this._apiManager=a,this._bucketingManager=i,this._ruleManager=l,this._loggerManager=s,this._eventManager=n,this._config=e,this._data=t(e,"data"),this._accountId=null===(d=this._data)||void 0===d?void 0:d.account_id,this._projectId=null===(g=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===g?void 0:g.id,this.dataStoreManager=t(e,"dataStore"),null===(c=null===(v=this._loggerManager)||void 0===v?void 0:v.trace)||void 0===c||c.call(v,o.DATA_CONSTRUCTOR,this)}set data(e){var t,i,l;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id):null===(l=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===l||l.call(i,a.CONFIG_DATA_NOT_VALID)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,this._dataStoreManager=new g(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})}get dataStoreManager(){return this._dataStoreManager}matchRulesByField(e,t,i,l,n="key",a=this._environment){var r,d,u,g,v,c,h,_,M,f,y,S,I,O,m,p,E,T,b,k,D;null===(d=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===d||d.call(r,"DataManager.matchRulesByField()",{visitorId:e,identity:t,visitorProperties:i,locationProperties:l,identityField:n,environment:a});const A=this._getEntityByField(t,"experiences",n),B=!!this.getEntitiesList("archived_experiences").find((e=>String(null==A?void 0:A.id)===String(e))),L=!Array.isArray(null==A?void 0:A.environments)||(!A.environments.length||A.environments.includes(a)),C=this.getLocalStore(e)||{},{locations:N=[]}=C;let R=[];if(A&&!B&&L){let t=!1,n=[];if(l){if(Array.isArray(null==A?void 0:A.locations)&&A.locations.length){if(n=A.locations.filter((e=>N.includes(e.toString()))),!n.length){const e=this.getItemsByIds(A.locations,"locations");if(e.length&&(n=this.filterMatchedRecordsWithRule(e,l),R=n.filter((e=>Object.values(s).includes(e))),R.length))return R[0]}t=Boolean(n.length)}else if(null==A?void 0:A.site_area){if(t=this._ruleManager.isRuleMatched(l,A.site_area),Object.values(s).includes(t))return t}else t=!0;t&&(null===(g=null===(u=this._loggerManager)||void 0===u?void 0:u.info)||void 0===g||g.call(u,o.LOCATION_MATCH),null===(c=null===(v=this._loggerManager)||void 0===v?void 0:v.debug)||void 0===c||c.call(v,{locationProperties:l}))}if(!l||t){let t=[],l=[],n=[],a=[];if(i&&Array.isArray(null==A?void 0:A.audiences)&&A.audiences.length){if(t=this.getItemsByIds(A.audiences,"audiences"),t.length&&(n=this.filterMatchedRecordsWithRule(t,i),R=n.filter((e=>Object.values(s).includes(e))),R.length))return R[0];l=this.getItemsByIds(A.audiences,"segments"),l.length&&(a=this.filterMatchedCustomSegments(l,e))}if(!i||n.length||a.length||!t.length){if(n.length&&(null===(_=null===(h=this._loggerManager)||void 0===h?void 0:h.info)||void 0===_||_.call(h,o.AUDIENCE_MATCH),null===(f=null===(M=this._loggerManager)||void 0===M?void 0:M.debug)||void 0===f||f.call(M,{visitorProperties:i})),a.length&&(null===(S=null===(y=this._loggerManager)||void 0===y?void 0:y.info)||void 0===S||S.call(y,o.SEGMENTATION_MATCH)),(null==A?void 0:A.variations)&&(null===(I=null==A?void 0:A.variations)||void 0===I?void 0:I.length))return A;null===(m=null===(O=this._loggerManager)||void 0===O?void 0:O.debug)||void 0===m||m.call(O,o.VARIATIONS_NOT_FOUND,{visitorProperties:i,audiences:t})}else null===(E=null===(p=this._loggerManager)||void 0===p?void 0:p.debug)||void 0===E||E.call(p,o.RULES_NOT_MATCH,{visitorProperties:i,audiences:t})}else null===(b=null===(T=this._loggerManager)||void 0===T?void 0:T.debug)||void 0===b||b.call(T,o.LOCATION_NOT_MATCH,{locationProperties:l,[(null==A?void 0:A.locations)?"experiences[].variations[].locations":"experiences[].variations[].site_area"]:(null==A?void 0:A.locations)||(null==A?void 0:A.site_area)||""})}else null===(D=null===(k=this._loggerManager)||void 0===k?void 0:k.debug)||void 0===D||D.call(k,o.EXPERIENCE_NOT_FOUND,{identity:t,identityField:n});return null}_getBucketingByField(e,t,i,l,n="key",a=this._environment){var r,o;null===(o=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===o||o.call(r,"DataManager._getBucketingByField()",{visitorId:e,identity:t,visitorProperties:i,locationProperties:l,identityField:n,environment:a});const d=this.matchRulesByField(e,t,i,l,n,a);return d?Object.values(s).includes(d)?d:this._retrieveBucketing(e,d):null}_retrieveBucketing(e,t){var i,l,n,r,s,u,g,v,c,h,_,M,f,y,S,I;if(!e||!t)return null;if(!(null==t?void 0:t.id))return null;let O=null,m=null;const p=this.getStoreKey(e),{bucketing:E,locations:T,segments:b}=this.getLocalStore(e)||{},{[t.id.toString()]:k}=E||{};if(k&&(O=this.retrieveVariation(t.id,k)))null===(l=null===(i=this._loggerManager)||void 0===i?void 0:i.info)||void 0===l||l.call(i,o.BUCKETED_VISITOR_FOUND),null===(r=null===(n=this._loggerManager)||void 0===n?void 0:n.debug)||void 0===r||r.call(n,{storeKey:p,visitorId:e,variationId:k});else{let{bucketing:{[t.id.toString()]:i}={}}=(null===(u=null===(s=this.dataStoreManager)||void 0===s?void 0:s.get)||void 0===u?void 0:u.call(s,p))||{};if(i&&(O=this.retrieveVariation(t.id,i)))this.putLocalStore(e,Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},E),{[t.id.toString()]:i})},T?{locations:T}:{}),b?{segments:b}:{})),null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===v||v.call(g,o.BUCKETED_VISITOR_FOUND),null===(h=null===(c=this._loggerManager)||void 0===c?void 0:c.debug)||void 0===h||h.call(c,{storeKey:p,visitorId:e,variationId:i});else{const l=t.variations.reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{});if(i=this._bucketingManager.getBucketForVisitor(l,e),i){null===(M=null===(_=this._loggerManager)||void 0===_?void 0:_.info)||void 0===M||M.call(_,o.BUCKETED_VISITOR);const l=Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},E),{[t.id.toString()]:i})},T?{locations:T}:{}),b?{segments:b}:{});this.putLocalStore(e,l),this.dataStoreManager.enqueue(p,l);const n={experienceId:t.id.toString(),variationId:i.toString()},a={eventType:d.BUCKETING,data:n};this._apiManager.enqueue(e,a,b),null===(y=null===(f=this._loggerManager)||void 0===f?void 0:f.trace)||void 0===y||y.call(f,"DataManager._retrieveBucketing()",{visitorEvent:a}),O=this.retrieveVariation(t.id,i)}else null===(I=null===(S=this._loggerManager)||void 0===S?void 0:S.error)||void 0===I||I.call(S,a.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:t})}}return O&&(m=Object.assign({experienceId:null==t?void 0:t.id,experienceName:null==t?void 0:t.name,experienceKey:null==t?void 0:t.key},O)),m}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}putLocalStore(e,t){const i=this.getStoreKey(e);if(this._bucketedVisitors.set(i,t),this._bucketedVisitors.size>this._localStoreLimit)for(const[e,t]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}}getLocalStore(e){const t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(e,t,l){var a,r,s,d,u,g,v,c,h;null===(r=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===r||r.call(a,"DataManager.selectLocations()",{items:t,locationProperties:l});const _=this.getLocalStore(e)||{},{bucketing:M,locations:f=[],segments:y}=_,S=[];let I;if(i(t))for(let i=0,a=t.length;i<a;i++)if(null===(s=null==t?void 0:t[i])||void 0===s?void 0:s.rules)if(I=this._ruleManager.isRuleMatched(l,t[i].rules),!0!==I||f.includes(t[i].id.toString())){if(!1!==I)S.push(I);else if(!1===I&&f.includes(t[i].id.toString())){this._eventManager.fire(n.LOCATION_DEACTIVATED,{visitorId:e,location:{id:t[i].id,key:t[i].key,name:t[i].name}},null,!0);const l=f.findIndex((e=>e===t[i].id.toString()));f.splice(l,1),null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===v||v.call(g,o.LOCATION_INACTIVE)}}else f.push(t[i].id.toString()),this._eventManager.fire(n.LOCATION_ACTIVATED,{visitorId:e,location:{id:t[i].id,key:t[i].key,name:t[i].name}},null,!0),S.push(t[i]),null===(u=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===u||u.call(d,o.LOCATION_ACTIVE);return this.putLocalStore(e,Object.assign(Object.assign(Object.assign({},M?{bucketing:M}:{}),{locations:f}),y?{segments:y}:{})),null===(h=null===(c=this._loggerManager)||void 0===c?void 0:c.debug)||void 0===h||h.call(c,"DataManager.selectLocations()",{matchedRecords:S}),S}getBucketing(e,t,i,l,n=this._environment){return this._getBucketingByField(e,t,i,l,"key",n)}getBucketingById(e,t,i,l,n=this._environment){return this._getBucketingByField(e,t,i,l,"id",n)}convert(e,t,i,l,n){var a,r,u,g,v,c;const h="string"==typeof t?this.getEntity(t,"goals"):this.getEntityById(t,"goals");if(!(null==h?void 0:h.id))return void(null===(r=null===(a=this._loggerManager)||void 0===a?void 0:a.error)||void 0===r||r.call(a,o.GOAL_NOT_FOUND));if(i){if(!(null==h?void 0:h.rules))return;const e=this._ruleManager.isRuleMatched(i,h.rules);if(Object.values(s).includes(e))return e;if(!e)return void(null===(g=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===g||g.call(u,o.GOAL_RULE_NOT_MATCH))}const _={goalId:h.id},{bucketing:M}=this.getLocalStore(e)||{};M&&(_.bucketingData=M);const f={eventType:d.CONVERSION,data:_};if(this._apiManager.enqueue(e,f,n),l){const t={goalId:h.id,goalData:l};M&&(t.bucketingData=M);const i={eventType:d.CONVERSION,data:t};this._apiManager.enqueue(e,i,n)}null===(c=null===(v=this._loggerManager)||void 0===v?void 0:v.trace)||void 0===c||c.call(v,"DataManager.convert()",{event:f})}filterMatchedRecordsWithRule(e,t){var l,n,a,r,o;null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===n||n.call(l,"DataManager.filterMatchedRecordsWithRule()",{items:e,visitorProperties:t});const s=[];let d;if(i(e))for(let i=0,l=e.length;i<l;i++)(null===(a=null==e?void 0:e[i])||void 0===a?void 0:a.rules)&&(d=this._ruleManager.isRuleMatched(t,e[i].rules),!0===d?s.push(e[i]):!1!==d&&s.push(d));return null===(o=null===(r=this._loggerManager)||void 0===r?void 0:r.debug)||void 0===o||o.call(r,"DataManager.filterMatchedRecordsWithRule()",{matchedRecords:s}),s}filterMatchedCustomSegments(e,t){var l,n,a,r,o;null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===n||n.call(l,"DataManager.filterMatchedCustomSegments()",{items:e,visitorId:t});const s=this.getLocalStore(t)||{},{segments:{[u.CUSTOM_SEGMENTS]:d=[]}={}}=s,g=[];if(i(e))for(let t=0,i=e.length;t<i;t++)(null===(a=null==e?void 0:e[t])||void 0===a?void 0:a.id)&&d.includes(e[t].id)&&g.push(e[t]);return null===(o=null===(r=this._loggerManager)||void 0===r?void 0:r.debug)||void 0===o||o.call(r,"DataManager.filterMatchedCustomSegments()",{matchedRecords:g}),g}getEntitiesList(e){var i,l;let n=[];return-1!==this._dataEntities.indexOf(e)&&(n=t(this._data,e)||[]),null===(l=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===l||l.call(i,"DataManager.getEntitiesList()",{entityType:e,list:n}),n}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(e,t,l="key"){var n,a,r;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager._getEntityByField()",{identity:e,entityType:t,identityField:l});const o=this.getEntitiesList(t);if(i(o))for(let t=0,i=o.length;t<i;t++)if(o[t]&&String(null===(r=o[t])||void 0===r?void 0:r[l])===String(e))return o[t];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(e,t){var l;const n=this.getEntitiesList(t),a=[];if(i(n))for(let t=0,i=n.length;t<i;t++)-1!==e.indexOf(null===(l=n[t])||void 0===l?void 0:l.key)&&a.push(n[t]);return a}getItemsByIds(e,t){var l,n,a,r;null===(n=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===n||n.call(l,"DataManager.getItemsByIds()",{ids:e,path:t});const o=[];if(i(e)){const l=this.getEntitiesList(t);if(i(l))for(let t=0,i=l.length;t<i;t++)-1===e.indexOf(Number(null===(a=l[t])||void 0===a?void 0:a.id))&&-1===e.indexOf(String(null===(r=l[t])||void 0===r?void 0:r.id))||o.push(l[t])}return o}getSubItem(e,t,i,l,n,a){var r;const o=this._getEntityByField(t,e,n);for(const e in o[i])if(String(null===(r=o[i][e])||void 0===r?void 0:r[a])===String(l))return o[i][e];return null}isValidConfigData(e){var t;return l(e)&&!!(null==e?void 0:e.account_id)&&!!(null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)}}export{v as DataManager,g as DataStoreManager};
//# sourceMappingURL=index.min.mjs.map
