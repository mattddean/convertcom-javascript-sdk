/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
import{objectDeepMerge as e,objectDeepValue as t,arrayNotEmpty as i,objectNotEmpty as n}from"@convertcom/js-sdk-utils";import{SystemEvents as s,DATA_ENTITIES as r,RuleError as a,EventType as l,SegmentsKeys as o}from"@convertcom/js-sdk-enums";class u{constructor(e,{dataStore:t,eventManager:i,loggerManager:n}={}){this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=n,this._eventManager=i,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=t,this._requestsQueue={}}set(e,t){var i,n;try{null===(n=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===n||n.call(i,e,t)}catch(e){}}get(e){var t,i;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){}return null}enqueue(t,i){const n={};n[t]=i,this._requestsQueue=e(this._requestsQueue,n),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var t,i;this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(i=null===(t=this._eventManager)||void 0===t?void 0:t.fire)||void 0===i||i.call(t,s.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){e&&this.isValidDataStore(e)&&(this._dataStore=e)}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}class d{constructor(e,{bucketingManager:i,ruleManager:n,eventManager:s,apiManager:a,loggerManager:l}){var o,u,d;this._dataEntities=r,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==e?void 0:e.environment,this._apiManager=a,this._bucketingManager=i,this._ruleManager=n,this._loggerManager=l,this._eventManager=s,this._config=e,this._data=t(e,"data"),this._accountId=null===(o=this._data)||void 0===o?void 0:o.account_id,this._projectId=null===(d=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===d?void 0:d.id,this.dataStoreManager=t(e,"dataStore")}set data(e){var t;this.isValidConfigData(e)&&(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,this._dataStoreManager=new u(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})}get dataStoreManager(){return this._dataStoreManager}matchRulesByField(e,t,i,n,s="key",r=this._environment){var l;const o=this._getEntityByField(t,"experiences",s),u=!!this.getEntitiesList("archived_experiences").find((e=>String(null==o?void 0:o.id)===String(e))),d=!Array.isArray(null==o?void 0:o.environments)||(!o.environments.length||o.environments.includes(r)),g=this.getLocalStore(e)||{},{locations:c=[]}=g;let h=[];if(o&&!u&&d){let t=!1,s=[];if(n)if(Array.isArray(null==o?void 0:o.locations)&&o.locations.length){if(s=o.locations.filter((e=>c.includes(e.toString()))),!s.length){const e=this.getItemsByIds(o.locations,"locations");if(e.length&&(s=this.filterMatchedRecordsWithRule(e,n),h=s.filter((e=>Object.values(a).includes(e))),h.length))return h[0]}t=Boolean(s.length)}else if(null==o?void 0:o.site_area){if(t=this._ruleManager.isRuleMatched(n,o.site_area),Object.values(a).includes(t))return t}else t=!0;if(!n||t){let t=[],n=[],s=[],r=[];if(i&&Array.isArray(null==o?void 0:o.audiences)&&o.audiences.length){if(t=this.getItemsByIds(o.audiences,"audiences"),t.length&&(s=this.filterMatchedRecordsWithRule(t,i),h=s.filter((e=>Object.values(a).includes(e))),h.length))return h[0];n=this.getItemsByIds(o.audiences,"segments"),n.length&&(r=this.filterMatchedCustomSegments(n,e))}if((!i||s.length||r.length||!t.length)&&(null==o?void 0:o.variations)&&(null===(l=null==o?void 0:o.variations)||void 0===l?void 0:l.length))return o}}return null}_getBucketingByField(e,t,i,n,s="key",r=this._environment){const l=this.matchRulesByField(e,t,i,n,s,r);return l?Object.values(a).includes(l)?l:this._retrieveBucketing(e,l):null}_retrieveBucketing(e,t){var i,n;if(!e||!t)return null;if(!(null==t?void 0:t.id))return null;let s=null,r=null;const a=this.getStoreKey(e),{bucketing:o,locations:u,segments:d}=this.getLocalStore(e)||{},{[t.id.toString()]:g}=o||{};if(g&&(s=this.retrieveVariation(t.id,g)));else{let{bucketing:{[t.id.toString()]:r}={}}=(null===(n=null===(i=this.dataStoreManager)||void 0===i?void 0:i.get)||void 0===n?void 0:n.call(i,a))||{};if(r&&(s=this.retrieveVariation(t.id,r)))this.putLocalStore(e,Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},o),{[t.id.toString()]:r})},u?{locations:u}:{}),d?{segments:d}:{}));else{const i=t.variations.reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{});if(r=this._bucketingManager.getBucketForVisitor(i,e),r){const i=Object.assign(Object.assign({bucketing:Object.assign(Object.assign({},o),{[t.id.toString()]:r})},u?{locations:u}:{}),d?{segments:d}:{});this.putLocalStore(e,i),this.dataStoreManager.enqueue(a,i);const n={experienceId:t.id.toString(),variationId:r.toString()},g={eventType:l.BUCKETING,data:n};this._apiManager.enqueue(e,g,d),s=this.retrieveVariation(t.id,r)}}}return s&&(r=Object.assign({experienceId:null==t?void 0:t.id,experienceName:null==t?void 0:t.name,experienceKey:null==t?void 0:t.key},s)),r}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}putLocalStore(e,t){const i=this.getStoreKey(e);if(this._bucketedVisitors.set(i,t),this._bucketedVisitors.size>this._localStoreLimit)for(const[e,t]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}}getLocalStore(e){const t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(e,t,n){var r;const a=this.getLocalStore(e)||{},{bucketing:l,locations:o=[],segments:u}=a,d=[];let g;if(i(t))for(let i=0,a=t.length;i<a;i++)if(null===(r=null==t?void 0:t[i])||void 0===r?void 0:r.rules)if(g=this._ruleManager.isRuleMatched(n,t[i].rules),!0!==g||o.includes(t[i].id.toString())){if(!1!==g)d.push(g);else if(!1===g&&o.includes(t[i].id.toString())){this._eventManager.fire(s.LOCATION_DEACTIVATED,{visitorId:e,location:{id:t[i].id,key:t[i].key,name:t[i].name}},null,!0);const n=o.findIndex((e=>e===t[i].id.toString()));o.splice(n,1)}}else o.push(t[i].id.toString()),this._eventManager.fire(s.LOCATION_ACTIVATED,{visitorId:e,location:{id:t[i].id,key:t[i].key,name:t[i].name}},null,!0),d.push(t[i]);return this.putLocalStore(e,Object.assign(Object.assign(Object.assign({},l?{bucketing:l}:{}),{locations:o}),u?{segments:u}:{})),d}getBucketing(e,t,i,n,s=this._environment){return this._getBucketingByField(e,t,i,n,"key",s)}getBucketingById(e,t,i,n,s=this._environment){return this._getBucketingByField(e,t,i,n,"id",s)}convert(e,t,i,n,s){const r="string"==typeof t?this.getEntity(t,"goals"):this.getEntityById(t,"goals");if(!(null==r?void 0:r.id))return;if(i){if(!(null==r?void 0:r.rules))return;const e=this._ruleManager.isRuleMatched(i,r.rules);if(Object.values(a).includes(e))return e;if(!e)return}const o={goalId:r.id},{bucketing:u}=this.getLocalStore(e)||{};u&&(o.bucketingData=u);const d={eventType:l.CONVERSION,data:o};if(this._apiManager.enqueue(e,d,s),n){const t={goalId:r.id,goalData:n};u&&(t.bucketingData=u);const i={eventType:l.CONVERSION,data:t};this._apiManager.enqueue(e,i,s)}}filterMatchedRecordsWithRule(e,t){var n;const s=[];let r;if(i(e))for(let i=0,a=e.length;i<a;i++)(null===(n=null==e?void 0:e[i])||void 0===n?void 0:n.rules)&&(r=this._ruleManager.isRuleMatched(t,e[i].rules),!0===r?s.push(e[i]):!1!==r&&s.push(r));return s}filterMatchedCustomSegments(e,t){var n;const s=this.getLocalStore(t)||{},{segments:{[o.CUSTOM_SEGMENTS]:r=[]}={}}=s,a=[];if(i(e))for(let t=0,i=e.length;t<i;t++)(null===(n=null==e?void 0:e[t])||void 0===n?void 0:n.id)&&r.includes(e[t].id)&&a.push(e[t]);return a}getEntitiesList(e){let i=[];return-1!==this._dataEntities.indexOf(e)&&(i=t(this._data,e)||[]),i}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(e,t,n="key"){var s;const r=this.getEntitiesList(t);if(i(r))for(let t=0,i=r.length;t<i;t++)if(r[t]&&String(null===(s=r[t])||void 0===s?void 0:s[n])===String(e))return r[t];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(e,t){var n;const s=this.getEntitiesList(t),r=[];if(i(s))for(let t=0,i=s.length;t<i;t++)-1!==e.indexOf(null===(n=s[t])||void 0===n?void 0:n.key)&&r.push(s[t]);return r}getItemsByIds(e,t){var n,s;const r=[];if(i(e)){const a=this.getEntitiesList(t);if(i(a))for(let t=0,i=a.length;t<i;t++)-1===e.indexOf(Number(null===(n=a[t])||void 0===n?void 0:n.id))&&-1===e.indexOf(String(null===(s=a[t])||void 0===s?void 0:s.id))||r.push(a[t])}return r}getSubItem(e,t,i,n,s,r){var a;const l=this._getEntityByField(t,e,s);for(const e in l[i])if(String(null===(a=l[i][e])||void 0===a?void 0:a[r])===String(n))return l[i][e];return null}isValidConfigData(e){var t;return n(e)&&!!(null==e?void 0:e.account_id)&&!!(null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)}}export{d as DataManager,u as DataStoreManager};
//# sourceMappingURL=index.min.mjs.map
