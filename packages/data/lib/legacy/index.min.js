/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/js-sdk-utils"),t=require("@convertcom/js-sdk-enums"),i=function(){return i=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},i.apply(this,arguments)};function r(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,o=i.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a}"function"==typeof SuppressedError&&SuppressedError;var n=function(){function i(e,t){var i=void 0===t?{}:t,r=i.dataStore,n=i.eventManager,o=i.loggerManager;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=o,this._eventManager=n,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=r,this._requestsQueue={}}return i.prototype.set=function(e,t){var i,r,n,o;try{null===(r=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===r||r.call(i,e,t)}catch(e){null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===o||o.call(n,"DataStoreManager.set()",{error:e.message})}},i.prototype.get=function(e){var t,i,r,n;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"DataStoreManager.get()",{error:e.message})}return null},i.prototype.enqueue=function(t,i){var r={};r[t]=i,this._requestsQueue=e.objectDeepMerge(this._requestsQueue,r),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()},i.prototype.releaseQueue=function(e){var i,r;for(var n in this.stopQueue(),this._requestsQueue)this.set(n,this._requestsQueue[n]);null===(r=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===r||r.call(i,t.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})},i.prototype.stopQueue=function(){clearTimeout(this._requestsQueueTimerID)},i.prototype.startQueue=function(){var e=this;this._requestsQueueTimerID=setTimeout((function(){e.releaseQueue("timeout")}),this.releaseInterval)},Object.defineProperty(i.prototype,"dataStore",{get:function(){return this._dataStore},set:function(e){var i,r;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,t.ERROR_MESSAGES.DATA_STORE_NOT_VALID))},enumerable:!1,configurable:!0}),i.prototype.isValidDataStore=function(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set},i}(),o=function(){function o(i,r){var n,o,a,l=r.bucketingManager,u=r.ruleManager,s=r.eventManager,d=r.apiManager,c=r.loggerManager;this._dataEntities=t.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=d,this._bucketingManager=l,this._ruleManager=u,this._loggerManager=c,this._eventManager=s,this._config=i,this._data=e.objectDeepValue(i,"data"),this._accountId=null===(n=this._data)||void 0===n?void 0:n.account_id,this._projectId=null===(a=null===(o=this._data)||void 0===o?void 0:o.project)||void 0===a?void 0:a.id,this.dataStoreManager=e.objectDeepValue(i,"dataStore")}return Object.defineProperty(o.prototype,"data",{get:function(){return this._data},set:function(e){var i,r,n;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(i=null==e?void 0:e.project)||void 0===i?void 0:i.id):null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,t.ERROR_MESSAGES.CONFIG_DATA_NOT_VALID)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"dataStoreManager",{get:function(){return this._dataStoreManager},set:function(e){this._dataStoreManager=null,this._dataStoreManager=new n(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})},enumerable:!1,configurable:!0}),o.prototype.matchRulesByField=function(e,i,r,n,o,a){var l,u,s,d,c,v,g;void 0===o&&(o="key"),void 0===a&&(a=this._environment);var h=this._getEntityByField(i,"experiences",o),f=!!this.getEntitiesList("archived_experiences").find((function(e){return String(null==h?void 0:h.id)===String(e)})),p=!Array.isArray(null==h?void 0:h.environments)||(!h.environments.length||h.environments.includes(a)),y=(this.getLocalStore(e)||{}).locations,_=void 0===y?[]:y,S=[];if(h&&!f&&p){var E=!1,M=[];if(n){if(Array.isArray(null==h?void 0:h.locations)&&h.locations.length){if(!(M=h.locations.filter((function(e){return _.includes(e.toString())}))).length){var m=this.getItemsByIds(h.locations,"locations");if(m.length&&(S=(M=this.filterMatchedRecordsWithRule(m,n)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return S[0]}E=Boolean(M.length)}else if(null==h?void 0:h.site_area){if(E=this._ruleManager.isRuleMatched(n,h.site_area),Object.values(t.RuleError).includes(E))return E}else E=!0;E&&(null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.info)||void 0===u||u.call(l,t.MESSAGES.LOCATION_MATCH))}if(!n||E){var I=[],b=[],O=[],T=[];if(r&&Array.isArray(null==h?void 0:h.audiences)&&h.audiences.length){if((I=this.getItemsByIds(h.audiences,"audiences")).length&&(S=(O=this.filterMatchedRecordsWithRule(I,r)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return S[0];(b=this.getItemsByIds(h.audiences,"segments")).length&&(T=this.filterMatchedCustomSegments(b,e))}if((!r||O.length||T.length||!I.length)&&(O.length&&(null===(d=null===(s=this._loggerManager)||void 0===s?void 0:s.info)||void 0===d||d.call(s,t.MESSAGES.AUDIENCE_MATCH)),T.length&&(null===(v=null===(c=this._loggerManager)||void 0===c?void 0:c.info)||void 0===v||v.call(c,t.MESSAGES.SEGMENTATION_MATCH)),(null==h?void 0:h.variations)&&(null===(g=null==h?void 0:h.variations)||void 0===g?void 0:g.length)))return h}}return null},o.prototype._getBucketingByField=function(e,i,r,n,o,a){void 0===o&&(o="key"),void 0===a&&(a=this._environment);var l=this.matchRulesByField(e,i,r,n,o,a);return l?Object.values(t.RuleError).includes(l)?l:this._retrieveBucketing(e,l):null},o.prototype._retrieveBucketing=function(e,r){var n,o,a,l,u,s,d,c,v,g,h,f;if(!e||!r)return null;if(!(null==r?void 0:r.id))return null;var p=null,y=null,_=this.getStoreKey(e),S=this.getLocalStore(e)||{},E=S.bucketing,M=S.locations,m=S.segments,I=(E||{})[r.id.toString()];if(I&&(p=this.retrieveVariation(r.id,I)))null===(l=null===(a=this._loggerManager)||void 0===a?void 0:a.info)||void 0===l||l.call(a,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#","#".concat(I)));else{var b=((null===(s=null===(u=this.dataStoreManager)||void 0===u?void 0:u.get)||void 0===s?void 0:s.call(u,_))||{}).bucketing,O=(void 0===b?{}:b)[r.id.toString()];if(O&&(p=this.retrieveVariation(r.id,O)))this.putLocalStore(e,i(i({bucketing:i(i({},E),(n={},n[r.id.toString()]=O,n))},M?{locations:M}:{}),m?{segments:m}:{})),null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===c||c.call(d,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#","#".concat(O)));else{var T=r.variations.reduce((function(e,t){return(null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e}),{});if(O=this._bucketingManager.getBucketForVisitor(T,e)){null===(g=null===(v=this._loggerManager)||void 0===v?void 0:v.info)||void 0===g||g.call(v,t.MESSAGES.BUCKETED_VISITOR.replace("#","#".concat(O)));var A=i(i({bucketing:i(i({},E),(o={},o[r.id.toString()]=O,o))},M?{locations:M}:{}),m?{segments:m}:{});this.putLocalStore(e,A),this.dataStoreManager.enqueue(_,A);var k={experienceId:r.id.toString(),variationId:O.toString()},D={eventType:t.EventType.BUCKETING,data:k};this._apiManager.enqueue(e,D,m),p=this.retrieveVariation(r.id,O)}else null===(f=null===(h=this._loggerManager)||void 0===h?void 0:h.error)||void 0===f||f.call(h,t.ERROR_MESSAGES.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:r})}}return p&&(y=i({experienceId:null==r?void 0:r.id,experienceName:null==r?void 0:r.name,experienceKey:null==r?void 0:r.key},p)),y},o.prototype.retrieveVariation=function(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")},o.prototype.putLocalStore=function(e,t){var i,n,o=this.getStoreKey(e);if(this._bucketedVisitors.set(o,t),this._bucketedVisitors.size>this._localStoreLimit)try{for(var a=function(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}(this._bucketedVisitors),l=a.next();!l.done;l=a.next()){var u=r(l.value,2),s=u[0];u[1];this._bucketedVisitors.delete(s);break}}catch(e){i={error:e}}finally{try{l&&!l.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}},o.prototype.getLocalStore=function(e){var t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null},o.prototype.getStoreKey=function(e){return"".concat(this._accountId,"-").concat(this._projectId,"-").concat(e)},o.prototype.selectLocations=function(r,n,o){var a,l,u,s,d,c,v=this.getLocalStore(r)||{},g=v.bucketing,h=v.locations,f=void 0===h?[]:h,p=v.segments,y=[];if(e.arrayNotEmpty(n))for(var _=function(e,i){if(!(null===(a=null==n?void 0:n[e])||void 0===a?void 0:a.rules))return"continue";if(!0!==(c=S._ruleManager.isRuleMatched(o,n[e].rules))||f.includes(n[e].id.toString())){if(!1!==c)y.push(c);else if(!1===c&&f.includes(n[e].id.toString())){S._eventManager.fire(t.SystemEvents.LOCATION_DEACTIVATED,{visitorId:r,location:{id:n[e].id,key:n[e].key,name:n[e].name}},null,!0);var v=f.findIndex((function(t){return t===n[e].id.toString()}));f.splice(v,1),null===(d=null===(s=S._loggerManager)||void 0===s?void 0:s.info)||void 0===d||d.call(s,t.MESSAGES.LOCATION_DEACTIVATED.replace("#","#".concat(n[e].id)))}}else f.push(n[e].id.toString()),S._eventManager.fire(t.SystemEvents.LOCATION_ACTIVATED,{visitorId:r,location:{id:n[e].id,key:n[e].key,name:n[e].name}},null,!0),y.push(n[e]),null===(u=null===(l=S._loggerManager)||void 0===l?void 0:l.info)||void 0===u||u.call(l,t.MESSAGES.LOCATION_ACTIVATED.replace("#","#".concat(n[e].id)))},S=this,E=0,M=n.length;E<M;E++)_(E);return this.putLocalStore(r,i(i(i({},g?{bucketing:g}:{}),{locations:f}),p?{segments:p}:{})),y},o.prototype.getBucketing=function(e,t,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(e,t,i,r,"key",n)},o.prototype.getBucketingById=function(e,t,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(e,t,i,r,"id",n)},o.prototype.convert=function(e,i,r,n,o){var a,l,u,s,d="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(null==d?void 0:d.id){if(r){if(!(null==d?void 0:d.rules))return;var c=this._ruleManager.isRuleMatched(r,d.rules);if(Object.values(t.RuleError).includes(c))return c;if(!c)return void(null===(s=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===s||s.call(u,t.MESSAGES.GOAL_RULE_NOT_MATCH))}var v={goalId:d.id},g=(this.getLocalStore(e)||{}).bucketing;g&&(v.bucketingData=g);var h={eventType:t.EventType.CONVERSION,data:v};if(this._apiManager.enqueue(e,h,o),n){var f={goalId:d.id,goalData:n};g&&(f.bucketingData=g);var p={eventType:t.EventType.CONVERSION,data:f};this._apiManager.enqueue(e,p,o)}}else null===(l=null===(a=this._loggerManager)||void 0===a?void 0:a.error)||void 0===l||l.call(a,t.MESSAGES.GOAL_NOT_FOUND)},o.prototype.filterMatchedRecordsWithRule=function(t,i){var r,n,o=[];if(e.arrayNotEmpty(t))for(var a=0,l=t.length;a<l;a++)(null===(r=null==t?void 0:t[a])||void 0===r?void 0:r.rules)&&(!0===(n=this._ruleManager.isRuleMatched(i,t[a].rules))?o.push(t[a]):!1!==n&&o.push(n));return o},o.prototype.filterMatchedCustomSegments=function(i,r){var n,o=(this.getLocalStore(r)||{}).segments,a=(void 0===o?{}:o)[t.SegmentsKeys.CUSTOM_SEGMENTS],l=void 0===a?[]:a,u=[];if(e.arrayNotEmpty(i))for(var s=0,d=i.length;s<d;s++)(null===(n=null==i?void 0:i[s])||void 0===n?void 0:n.id)&&l.includes(i[s].id)&&u.push(i[s]);return u},o.prototype.getEntitiesList=function(t){var i=[];return-1!==this._dataEntities.indexOf(t)&&(i=e.objectDeepValue(this._data,t)||[]),i},o.prototype.getEntitiesListObject=function(e,t){return void 0===t&&(t="id"),this.getEntitiesList(e).reduce((function(e,i){return e[i[t]]=i,e}),{})},o.prototype._getEntityByField=function(t,i,r){var n;void 0===r&&(r="key");var o=this.getEntitiesList(i);if(e.arrayNotEmpty(o))for(var a=0,l=o.length;a<l;a++)if(o[a]&&String(null===(n=o[a])||void 0===n?void 0:n[r])===String(t))return o[a];return null},o.prototype.getEntity=function(e,t){return this._getEntityByField(e,t,"key")},o.prototype.getEntities=function(e,t){return this.getItemsByKeys(e,t)},o.prototype.getEntityById=function(e,t){return this._getEntityByField(e,t,"id")},o.prototype.getEntitiesByIds=function(e,t){return this.getItemsByIds(e,t)},o.prototype.getItemsByKeys=function(t,i){var r,n=this.getEntitiesList(i),o=[];if(e.arrayNotEmpty(n))for(var a=0,l=n.length;a<l;a++)-1!==t.indexOf(null===(r=n[a])||void 0===r?void 0:r.key)&&o.push(n[a]);return o},o.prototype.getItemsByIds=function(t,i){var r,n,o=[];if(e.arrayNotEmpty(t)){var a=this.getEntitiesList(i);if(e.arrayNotEmpty(a))for(var l=0,u=a.length;l<u;l++)-1===t.indexOf(Number(null===(r=a[l])||void 0===r?void 0:r.id))&&-1===t.indexOf(String(null===(n=a[l])||void 0===n?void 0:n.id))||o.push(a[l])}return o},o.prototype.getSubItem=function(e,t,i,r,n,o){var a,l=this._getEntityByField(t,e,n);for(var u in l[i])if(String(null===(a=l[i][u])||void 0===a?void 0:a[o])===String(r))return l[i][u];return null},o.prototype.isValidConfigData=function(t){var i;return e.objectNotEmpty(t)&&!!(null==t?void 0:t.account_id)&&!!(null===(i=null==t?void 0:t.project)||void 0===i?void 0:i.id)},o}();exports.DataManager=o,exports.DataStoreManager=n;
//# sourceMappingURL=index.min.js.map
