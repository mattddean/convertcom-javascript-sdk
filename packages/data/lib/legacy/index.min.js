/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/js-sdk-utils"),t=require("@convertcom/js-sdk-enums"),i=function(){return i=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var n in t=arguments[i])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},i.apply(this,arguments)};function r(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,o=i.call(e),l=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)l.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return l}"function"==typeof SuppressedError&&SuppressedError;var o=function(){function i(e,t){var i=void 0===t?{}:t,r=i.dataStore,n=i.eventManager,o=i.loggerManager;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=o,this._eventManager=n,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=r,this._requestsQueue={}}return i.prototype.set=function(e,t){var i,r,n,o;try{null===(r=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===r||r.call(i,e,t)}catch(e){null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===o||o.call(n,"DataStoreManager.set()",{error:e.message})}},i.prototype.get=function(e){var t,i,r,n;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"DataStoreManager.get()",{error:e.message})}return null},i.prototype.enqueue=function(t,i){var r={};r[t]=i,this._requestsQueue=e.objectDeepMerge(this._requestsQueue,r),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()},i.prototype.releaseQueue=function(e){var i,r;for(var n in this.stopQueue(),this._requestsQueue)this.set(n,this._requestsQueue[n]);null===(r=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===r||r.call(i,t.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})},i.prototype.stopQueue=function(){clearTimeout(this._requestsQueueTimerID)},i.prototype.startQueue=function(){var e=this;this._requestsQueueTimerID=setTimeout((function(){e.releaseQueue("timeout")}),this.releaseInterval)},Object.defineProperty(i.prototype,"dataStore",{get:function(){return this._dataStore},set:function(e){var i,r;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,t.ERROR_MESSAGES.DATA_STORE_NOT_VALID))},enumerable:!1,configurable:!0}),i.prototype.isValidDataStore=function(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set},i}(),l=function(){function l(i,r){var n,o,l,a=r.bucketingManager,u=r.ruleManager,s=r.eventManager,d=r.apiManager,c=r.loggerManager;this._dataEntities=t.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=d,this._bucketingManager=a,this._ruleManager=u,this._loggerManager=c,this._eventManager=s,this._config=i,this._data=e.objectDeepValue(i,"data"),this._accountId=null===(n=this._data)||void 0===n?void 0:n.account_id,this._projectId=null===(l=null===(o=this._data)||void 0===o?void 0:o.project)||void 0===l?void 0:l.id,this.dataStoreManager=e.objectDeepValue(i,"dataStore")}return Object.defineProperty(l.prototype,"data",{get:function(){return this._data},set:function(e){var i,r,n;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(i=null==e?void 0:e.project)||void 0===i?void 0:i.id):null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,t.ERROR_MESSAGES.CONFIG_DATA_NOT_VALID)},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"dataStoreManager",{get:function(){return this._dataStoreManager},set:function(e){this._dataStoreManager=null,this._dataStoreManager=new o(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})},enumerable:!1,configurable:!0}),l.prototype.matchRulesByField=function(e,i,n,o,l,a){var u,s,d,c,v,g,h,f,y,p,_,S,E,M,m,I,O;void 0===l&&(l="key"),void 0===a&&(a=this._environment);var T=this._getEntityByField(i,"experiences",l),A=!!this.getEntitiesList("archived_experiences").find((function(e){return String(null==T?void 0:T.id)===String(e)})),b=!Array.isArray(null==T?void 0:T.environments)||(!T.environments.length||T.environments.includes(a)),k=[];if(T&&!A&&b){var N=!1,D=[];if(o)if(Array.isArray(null==T?void 0:T.locations)&&T.locations.length){var R=this.getItemsByIds(T.locations,"locations");if(R.length&&(k=(D=this.selectLocations(e,R,o)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return k[0];N=Boolean(D.length)}else if(null==T?void 0:T.site_area){if(N=this._ruleManager.isRuleMatched(o,T.site_area),Object.values(t.RuleError).includes(N))return N}else N=!0;if(!o||N){var B=[],L=[],C=[],V=[];if(n&&Array.isArray(null==T?void 0:T.audiences)&&T.audiences.length){if((B=this.getItemsByIds(T.audiences,"audiences")).length){if((k=(C=this.filterMatchedRecordsWithRule(B,n)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return k[0];if(C.length)try{for(var j=r(C),x=j.next();!x.done;x=j.next()){var G=x.value;null===(g=null===(v=this._loggerManager)||void 0===v?void 0:v.info)||void 0===g||g.call(v,t.MESSAGES.AUDIENCE_MATCH.replace("#",(null==G?void 0:G.id)||(null==G?void 0:G.key)))}}catch(e){u={error:e}}finally{try{x&&!x.done&&(s=j.return)&&s.call(j)}finally{if(u)throw u.error}}}if((L=this.getItemsByIds(T.audiences,"segments")).length&&(V=this.filterMatchedCustomSegments(L,e)).length)try{for(var F=r(V),Q=F.next();!Q.done;Q=F.next()){G=Q.value;null===(f=null===(h=this._loggerManager)||void 0===h?void 0:h.info)||void 0===f||f.call(h,t.MESSAGES.SEGMENTATION_MATCH.replace("#",(null==G?void 0:G.id)||(null==G?void 0:G.key)))}}catch(e){d={error:e}}finally{try{Q&&!Q.done&&(c=F.return)&&c.call(F)}finally{if(d)throw d.error}}}if(!n||C.length||V.length||!B.length){if((null==T?void 0:T.variations)&&(null===(y=null==T?void 0:T.variations)||void 0===y?void 0:y.length))return T;null===(_=null===(p=this._loggerManager)||void 0===p?void 0:p.info)||void 0===_||_.call(p,t.MESSAGES.VARIATIONS_NOT_FOUND)}else null===(E=null===(S=this._loggerManager)||void 0===S?void 0:S.info)||void 0===E||E.call(S,t.MESSAGES.AUDIENCE_NOT_MATCH)}else null===(m=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===m||m.call(M,t.MESSAGES.LOCATION_NOT_MATCH)}else null===(O=null===(I=this._loggerManager)||void 0===I?void 0:I.info)||void 0===O||O.call(I,t.MESSAGES.EXPERIENCE_NOT_FOUND);return null},l.prototype._getBucketingByField=function(e,i,r,n,o,l){void 0===o&&(o="key"),void 0===l&&(l=this._environment);var a=this.matchRulesByField(e,i,r,n,o,l);return a?Object.values(t.RuleError).includes(a)?a:this._retrieveBucketing(e,a):null},l.prototype._retrieveBucketing=function(e,r){var n,o,l,a,u,s,d,c,v,g,h,f;if(!e||!r)return null;if(!(null==r?void 0:r.id))return null;var y=null,p=null,_=this.getStoreKey(e),S=this.getLocalStore(e)||{},E=S.bucketing,M=S.locations,m=S.segments,I=(E||{})[r.id.toString()];if(I&&(y=this.retrieveVariation(r.id,I)))null===(a=null===(l=this._loggerManager)||void 0===l?void 0:l.info)||void 0===a||a.call(l,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#","#".concat(I)));else{var O=((null===(s=null===(u=this.dataStoreManager)||void 0===u?void 0:u.get)||void 0===s?void 0:s.call(u,_))||{}).bucketing,T=(void 0===O?{}:O)[r.id.toString()];if(T&&(y=this.retrieveVariation(r.id,T)))this.putLocalStore(e,i(i({bucketing:i(i({},E),(n={},n[r.id.toString()]=T,n))},M?{locations:M}:{}),m?{segments:m}:{})),null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===c||c.call(d,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#","#".concat(T)));else{var A=r.variations.reduce((function(e,t){return(null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e}),{});if(T=this._bucketingManager.getBucketForVisitor(A,e)){null===(g=null===(v=this._loggerManager)||void 0===v?void 0:v.info)||void 0===g||g.call(v,t.MESSAGES.BUCKETED_VISITOR.replace("#","#".concat(T)));var b=i(i({bucketing:i(i({},E),(o={},o[r.id.toString()]=T,o))},M?{locations:M}:{}),m?{segments:m}:{});this.putLocalStore(e,b),this.dataStoreManager.enqueue(_,b);var k={experienceId:r.id.toString(),variationId:T.toString()},N={eventType:t.EventType.BUCKETING,data:k};this._apiManager.enqueue(e,N,m),y=this.retrieveVariation(r.id,T)}else null===(f=null===(h=this._loggerManager)||void 0===h?void 0:h.error)||void 0===f||f.call(h,t.ERROR_MESSAGES.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:r})}}return y&&(p=i({experienceId:null==r?void 0:r.id,experienceName:null==r?void 0:r.name,experienceKey:null==r?void 0:r.key},y)),p},l.prototype.retrieveVariation=function(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")},l.prototype.putLocalStore=function(e,t){var i,o,l=this.getStoreKey(e);if(this._bucketedVisitors.set(l,t),this._bucketedVisitors.size>this._localStoreLimit)try{for(var a=r(this._bucketedVisitors),u=a.next();!u.done;u=a.next()){var s=n(u.value,2),d=s[0];s[1];this._bucketedVisitors.delete(d);break}}catch(e){i={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(i)throw i.error}}},l.prototype.getLocalStore=function(e){var t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null},l.prototype.getStoreKey=function(e){return"".concat(this._accountId,"-").concat(this._projectId,"-").concat(e)},l.prototype.selectLocations=function(r,n,o){var l,a,u,s,d,c,v,g,h,f,y,p=this.getLocalStore(r)||{},_=p.bucketing,S=p.locations,E=void 0===S?[]:S,M=p.segments,m=[];if(e.arrayNotEmpty(n))for(var I=function(e,i){if(!(null===(l=null==n?void 0:n[e])||void 0===l?void 0:l.id))return"continue";if(!(null===(a=null==n?void 0:n[e])||void 0===a?void 0:a.rules))return"continue";if(!0!==(y=O._ruleManager.isRuleMatched(o,n[e].rules))||E.includes(n[e].id.toString())){if(!1!==y)m.push(y);else if(!1===y&&E.includes(n[e].id.toString())){O._eventManager.fire(t.SystemEvents.LOCATION_DEACTIVATED,{visitorId:r,location:{id:n[e].id,key:null===(v=n[e])||void 0===v?void 0:v.key,name:null===(g=n[e])||void 0===g?void 0:g.name}},null,!0);var p=E.findIndex((function(t){return t===n[e].id.toString()}));E.splice(p,1),null===(f=null===(h=O._loggerManager)||void 0===h?void 0:h.info)||void 0===f||f.call(h,t.MESSAGES.LOCATION_DEACTIVATED.replace("#","#".concat(n[e].id)))}}else E.push(n[e].id.toString()),O._eventManager.fire(t.SystemEvents.LOCATION_ACTIVATED,{visitorId:r,location:{id:n[e].id,key:null===(u=n[e])||void 0===u?void 0:u.key,name:null===(s=n[e])||void 0===s?void 0:s.name}},null,!0),m.push(n[e]),null===(c=null===(d=O._loggerManager)||void 0===d?void 0:d.info)||void 0===c||c.call(d,t.MESSAGES.LOCATION_ACTIVATED.replace("#","#".concat(n[e].id)))},O=this,T=0,A=n.length;T<A;T++)I(T);return this.putLocalStore(r,i(i(i({},_?{bucketing:_}:{}),{locations:E}),M?{segments:M}:{})),m},l.prototype.getBucketing=function(e,t,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(e,t,i,r,"key",n)},l.prototype.getBucketingById=function(e,t,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(e,t,i,r,"id",n)},l.prototype.convert=function(e,i,r,n,o){var l,a,u,s,d="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(null==d?void 0:d.id){if(r){if(!(null==d?void 0:d.rules))return;var c=this._ruleManager.isRuleMatched(r,d.rules);if(Object.values(t.RuleError).includes(c))return c;if(!c)return void(null===(s=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===s||s.call(u,t.MESSAGES.GOAL_RULE_NOT_MATCH))}var v={goalId:d.id},g=(this.getLocalStore(e)||{}).bucketing;g&&(v.bucketingData=g);var h={eventType:t.EventType.CONVERSION,data:v};if(this._apiManager.enqueue(e,h,o),n){var f={goalId:d.id,goalData:n};g&&(f.bucketingData=g);var y={eventType:t.EventType.CONVERSION,data:f};this._apiManager.enqueue(e,y,o)}}else null===(a=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===a||a.call(l,t.MESSAGES.GOAL_NOT_FOUND)},l.prototype.filterMatchedRecordsWithRule=function(t,i){var r,n,o=[];if(e.arrayNotEmpty(t))for(var l=0,a=t.length;l<a;l++)(null===(r=null==t?void 0:t[l])||void 0===r?void 0:r.rules)&&(!0===(n=this._ruleManager.isRuleMatched(i,t[l].rules))?o.push(t[l]):!1!==n&&o.push(n));return o},l.prototype.filterMatchedCustomSegments=function(i,r){var n,o=(this.getLocalStore(r)||{}).segments,l=(void 0===o?{}:o)[t.SegmentsKeys.CUSTOM_SEGMENTS],a=void 0===l?[]:l,u=[];if(e.arrayNotEmpty(i))for(var s=0,d=i.length;s<d;s++)(null===(n=null==i?void 0:i[s])||void 0===n?void 0:n.id)&&a.includes(i[s].id)&&u.push(i[s]);return u},l.prototype.getEntitiesList=function(t){var i=[];return-1!==this._dataEntities.indexOf(t)&&(i=e.objectDeepValue(this._data,t)||[]),i},l.prototype.getEntitiesListObject=function(e,t){return void 0===t&&(t="id"),this.getEntitiesList(e).reduce((function(e,i){return e[i[t]]=i,e}),{})},l.prototype._getEntityByField=function(t,i,r){var n;void 0===r&&(r="key");var o=this.getEntitiesList(i);if(e.arrayNotEmpty(o))for(var l=0,a=o.length;l<a;l++)if(o[l]&&String(null===(n=o[l])||void 0===n?void 0:n[r])===String(t))return o[l];return null},l.prototype.getEntity=function(e,t){return this._getEntityByField(e,t,"key")},l.prototype.getEntities=function(e,t){return this.getItemsByKeys(e,t)},l.prototype.getEntityById=function(e,t){return this._getEntityByField(e,t,"id")},l.prototype.getEntitiesByIds=function(e,t){return this.getItemsByIds(e,t)},l.prototype.getItemsByKeys=function(t,i){var r,n=this.getEntitiesList(i),o=[];if(e.arrayNotEmpty(n))for(var l=0,a=n.length;l<a;l++)-1!==t.indexOf(null===(r=n[l])||void 0===r?void 0:r.key)&&o.push(n[l]);return o},l.prototype.getItemsByIds=function(t,i){var r,n,o=[];if(e.arrayNotEmpty(t)){var l=this.getEntitiesList(i);if(e.arrayNotEmpty(l))for(var a=0,u=l.length;a<u;a++)-1===t.indexOf(Number(null===(r=l[a])||void 0===r?void 0:r.id))&&-1===t.indexOf(String(null===(n=l[a])||void 0===n?void 0:n.id))||o.push(l[a])}return o},l.prototype.getSubItem=function(e,t,i,r,n,o){var l,a=this._getEntityByField(t,e,n);for(var u in a[i])if(String(null===(l=a[i][u])||void 0===l?void 0:l[o])===String(r))return a[i][u];return null},l.prototype.isValidConfigData=function(t){var i;return e.objectNotEmpty(t)&&!!(null==t?void 0:t.account_id)&&!!(null===(i=null==t?void 0:t.project)||void 0===i?void 0:i.id)},l}();exports.DataManager=l,exports.DataStoreManager=o;
//# sourceMappingURL=index.min.js.map
