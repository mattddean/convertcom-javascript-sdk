/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var t=require("@convertcom/js-sdk-utils"),e=require("@convertcom/js-sdk-enums"),i=function(){return i=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var n in e=arguments[i])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},i.apply(this,arguments)};function r(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var r,n,o=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(t){n={error:t}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}return a}"function"==typeof SuppressedError&&SuppressedError;var n=function(){function i(t,e){var i=void 0===e?{}:e,r=i.dataStore,n=i.eventManager,o=i.loggerManager;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=o,this._eventManager=n,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=r,this._requestsQueue={}}return i.prototype.set=function(t,e){var i,r;try{null===(r=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===r||r.call(i,t,e)}catch(t){}},i.prototype.get=function(t){var e,i;try{return null===(i=null===(e=this.dataStore)||void 0===e?void 0:e.get)||void 0===i?void 0:i.call(e,t)}catch(t){}return null},i.prototype.enqueue=function(e,i){var r={};r[e]=i,this._requestsQueue=t.objectDeepMerge(this._requestsQueue,r),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()},i.prototype.releaseQueue=function(t){var i,r;for(var n in this.stopQueue(),this._requestsQueue)this.set(n,this._requestsQueue[n]);null===(r=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===r||r.call(i,e.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:t||""})},i.prototype.stopQueue=function(){clearTimeout(this._requestsQueueTimerID)},i.prototype.startQueue=function(){var t=this;this._requestsQueueTimerID=setTimeout((function(){t.releaseQueue("timeout")}),this.releaseInterval)},Object.defineProperty(i.prototype,"dataStore",{get:function(){return this._dataStore},set:function(t){t&&this.isValidDataStore(t)&&(this._dataStore=t)},enumerable:!1,configurable:!0}),i.prototype.isValidDataStore=function(t){return"object"==typeof t&&"function"==typeof t.get&&"function"==typeof t.set},i}(),o=function(){function o(i,r){var n,o,a,u=r.bucketingManager,s=r.ruleManager,l=r.eventManager,d=r.apiManager,c=r.loggerManager;this._dataEntities=e.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=d,this._bucketingManager=u,this._ruleManager=s,this._loggerManager=c,this._eventManager=l,this._config=i,this._data=t.objectDeepValue(i,"data"),this._accountId=null===(n=this._data)||void 0===n?void 0:n.account_id,this._projectId=null===(a=null===(o=this._data)||void 0===o?void 0:o.project)||void 0===a?void 0:a.id,this.dataStoreManager=t.objectDeepValue(i,"dataStore")}return Object.defineProperty(o.prototype,"data",{get:function(){return this._data},set:function(t){var e;this.isValidConfigData(t)&&(this._data=t,this._accountId=null==t?void 0:t.account_id,this._projectId=null===(e=null==t?void 0:t.project)||void 0===e?void 0:e.id)},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"dataStoreManager",{get:function(){return this._dataStoreManager},set:function(t){this._dataStoreManager=null,this._dataStoreManager=new n(this._config,{dataStore:t,eventManager:this._eventManager,loggerManager:this._loggerManager})},enumerable:!1,configurable:!0}),o.prototype.matchRulesByField=function(t,i,r,n,o,a){var u;void 0===o&&(o="key"),void 0===a&&(a=this._environment);var s=this._getEntityByField(i,"experiences",o),l=!!this.getEntitiesList("archived_experiences").find((function(t){return String(null==s?void 0:s.id)===String(t)})),d=!Array.isArray(null==s?void 0:s.environments)||(!s.environments.length||s.environments.includes(a)),c=(this.getLocalStore(t)||{}).locations,v=void 0===c?[]:c,g=[];if(s&&!l&&d){var h=!1,f=[];if(n)if(Array.isArray(null==s?void 0:s.locations)&&s.locations.length){if(!(f=s.locations.filter((function(t){return v.includes(t.toString())}))).length){var y=this.getItemsByIds(s.locations,"locations");if(y.length&&(g=(f=this.filterMatchedRecordsWithRule(y,n)).filter((function(t){return Object.values(e.RuleError).includes(t)}))).length)return g[0]}h=Boolean(f.length)}else if(null==s?void 0:s.site_area){if(h=this._ruleManager.isRuleMatched(n,s.site_area),Object.values(e.RuleError).includes(h))return h}else h=!0;if(!n||h){var p=[],_=[],S=[],m=[];if(r&&Array.isArray(null==s?void 0:s.audiences)&&s.audiences.length){if((p=this.getItemsByIds(s.audiences,"audiences")).length&&(g=(S=this.filterMatchedRecordsWithRule(p,r)).filter((function(t){return Object.values(e.RuleError).includes(t)}))).length)return g[0];(_=this.getItemsByIds(s.audiences,"segments")).length&&(m=this.filterMatchedCustomSegments(_,t))}if((!r||S.length||m.length||!p.length)&&(null==s?void 0:s.variations)&&(null===(u=null==s?void 0:s.variations)||void 0===u?void 0:u.length))return s}}return null},o.prototype._getBucketingByField=function(t,i,r,n,o,a){void 0===o&&(o="key"),void 0===a&&(a=this._environment);var u=this.matchRulesByField(t,i,r,n,o,a);return u?Object.values(e.RuleError).includes(u)?u:this._retrieveBucketing(t,u):null},o.prototype._retrieveBucketing=function(t,r){var n,o,a,u;if(!t||!r)return null;if(!(null==r?void 0:r.id))return null;var s=null,l=null,d=this.getStoreKey(t),c=this.getLocalStore(t)||{},v=c.bucketing,g=c.locations,h=c.segments,f=(v||{})[r.id.toString()];if(f&&(s=this.retrieveVariation(r.id,f)));else{var y=((null===(u=null===(a=this.dataStoreManager)||void 0===a?void 0:a.get)||void 0===u?void 0:u.call(a,d))||{}).bucketing,p=(void 0===y?{}:y)[r.id.toString()];if(p&&(s=this.retrieveVariation(r.id,p)))this.putLocalStore(t,i(i({bucketing:i(i({},v),(n={},n[r.id.toString()]=p,n))},g?{locations:g}:{}),h?{segments:h}:{}));else{var _=r.variations.reduce((function(t,e){return(null==e?void 0:e.id)&&(t[e.id]=(null==e?void 0:e.traffic_allocation)||100),t}),{});if(p=this._bucketingManager.getBucketForVisitor(_,t)){var S=i(i({bucketing:i(i({},v),(o={},o[r.id.toString()]=p,o))},g?{locations:g}:{}),h?{segments:h}:{});this.putLocalStore(t,S),this.dataStoreManager.enqueue(d,S);var m={experienceId:r.id.toString(),variationId:p.toString()},b={eventType:e.EventType.BUCKETING,data:m};this._apiManager.enqueue(t,b,h),s=this.retrieveVariation(r.id,p)}}}return s&&(l=i({experienceId:null==r?void 0:r.id,experienceName:null==r?void 0:r.name,experienceKey:null==r?void 0:r.key},s)),l},o.prototype.retrieveVariation=function(t,e){return this.getSubItem("experiences",t,"variations",e,"id","id")},o.prototype.putLocalStore=function(t,e){var i,n,o=this.getStoreKey(t);if(this._bucketedVisitors.set(o,e),this._bucketedVisitors.size>this._localStoreLimit)try{for(var a=function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],r=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(this._bucketedVisitors),u=a.next();!u.done;u=a.next()){var s=r(u.value,2),l=s[0];s[1];this._bucketedVisitors.delete(l);break}}catch(t){i={error:t}}finally{try{u&&!u.done&&(n=a.return)&&n.call(a)}finally{if(i)throw i.error}}},o.prototype.getLocalStore=function(t){var e=this.getStoreKey(t);return this._bucketedVisitors.get(e)||null},o.prototype.getStoreKey=function(t){return"".concat(this._accountId,"-").concat(this._projectId,"-").concat(t)},o.prototype.selectLocations=function(r,n,o){var a,u,s=this.getLocalStore(r)||{},l=s.bucketing,d=s.locations,c=void 0===d?[]:d,v=s.segments,g=[];if(t.arrayNotEmpty(n))for(var h=function(t,i){if(!(null===(a=null==n?void 0:n[t])||void 0===a?void 0:a.rules))return"continue";if(!0!==(u=f._ruleManager.isRuleMatched(o,n[t].rules))||c.includes(n[t].id.toString())){if(!1!==u)g.push(u);else if(!1===u&&c.includes(n[t].id.toString())){f._eventManager.fire(e.SystemEvents.LOCATION_DEACTIVATED,{visitorId:r,location:{id:n[t].id,key:n[t].key,name:n[t].name}},null,!0);var s=c.findIndex((function(e){return e===n[t].id.toString()}));c.splice(s,1)}}else c.push(n[t].id.toString()),f._eventManager.fire(e.SystemEvents.LOCATION_ACTIVATED,{visitorId:r,location:{id:n[t].id,key:n[t].key,name:n[t].name}},null,!0),g.push(n[t])},f=this,y=0,p=n.length;y<p;y++)h(y);return this.putLocalStore(r,i(i(i({},l?{bucketing:l}:{}),{locations:c}),v?{segments:v}:{})),g},o.prototype.getBucketing=function(t,e,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(t,e,i,r,"key",n)},o.prototype.getBucketingById=function(t,e,i,r,n){return void 0===n&&(n=this._environment),this._getBucketingByField(t,e,i,r,"id",n)},o.prototype.convert=function(t,i,r,n,o){var a="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(null==a?void 0:a.id){if(r){if(!(null==a?void 0:a.rules))return;var u=this._ruleManager.isRuleMatched(r,a.rules);if(Object.values(e.RuleError).includes(u))return u;if(!u)return}var s={goalId:a.id},l=(this.getLocalStore(t)||{}).bucketing;l&&(s.bucketingData=l);var d={eventType:e.EventType.CONVERSION,data:s};if(this._apiManager.enqueue(t,d,o),n){var c={goalId:a.id,goalData:n};l&&(c.bucketingData=l);var v={eventType:e.EventType.CONVERSION,data:c};this._apiManager.enqueue(t,v,o)}}},o.prototype.filterMatchedRecordsWithRule=function(e,i){var r,n,o=[];if(t.arrayNotEmpty(e))for(var a=0,u=e.length;a<u;a++)(null===(r=null==e?void 0:e[a])||void 0===r?void 0:r.rules)&&(!0===(n=this._ruleManager.isRuleMatched(i,e[a].rules))?o.push(e[a]):!1!==n&&o.push(n));return o},o.prototype.filterMatchedCustomSegments=function(i,r){var n,o=(this.getLocalStore(r)||{}).segments,a=(void 0===o?{}:o)[e.SegmentsKeys.CUSTOM_SEGMENTS],u=void 0===a?[]:a,s=[];if(t.arrayNotEmpty(i))for(var l=0,d=i.length;l<d;l++)(null===(n=null==i?void 0:i[l])||void 0===n?void 0:n.id)&&u.includes(i[l].id)&&s.push(i[l]);return s},o.prototype.getEntitiesList=function(e){var i=[];return-1!==this._dataEntities.indexOf(e)&&(i=t.objectDeepValue(this._data,e)||[]),i},o.prototype.getEntitiesListObject=function(t,e){return void 0===e&&(e="id"),this.getEntitiesList(t).reduce((function(t,i){return t[i[e]]=i,t}),{})},o.prototype._getEntityByField=function(e,i,r){var n;void 0===r&&(r="key");var o=this.getEntitiesList(i);if(t.arrayNotEmpty(o))for(var a=0,u=o.length;a<u;a++)if(o[a]&&String(null===(n=o[a])||void 0===n?void 0:n[r])===String(e))return o[a];return null},o.prototype.getEntity=function(t,e){return this._getEntityByField(t,e,"key")},o.prototype.getEntities=function(t,e){return this.getItemsByKeys(t,e)},o.prototype.getEntityById=function(t,e){return this._getEntityByField(t,e,"id")},o.prototype.getEntitiesByIds=function(t,e){return this.getItemsByIds(t,e)},o.prototype.getItemsByKeys=function(e,i){var r,n=this.getEntitiesList(i),o=[];if(t.arrayNotEmpty(n))for(var a=0,u=n.length;a<u;a++)-1!==e.indexOf(null===(r=n[a])||void 0===r?void 0:r.key)&&o.push(n[a]);return o},o.prototype.getItemsByIds=function(e,i){var r,n,o=[];if(t.arrayNotEmpty(e)){var a=this.getEntitiesList(i);if(t.arrayNotEmpty(a))for(var u=0,s=a.length;u<s;u++)-1===e.indexOf(Number(null===(r=a[u])||void 0===r?void 0:r.id))&&-1===e.indexOf(String(null===(n=a[u])||void 0===n?void 0:n.id))||o.push(a[u])}return o},o.prototype.getSubItem=function(t,e,i,r,n,o){var a,u=this._getEntityByField(e,t,n);for(var s in u[i])if(String(null===(a=u[i][s])||void 0===a?void 0:a[o])===String(r))return u[i][s];return null},o.prototype.isValidConfigData=function(e){var i;return t.objectNotEmpty(e)&&!!(null==e?void 0:e.account_id)&&!!(null===(i=null==e?void 0:e.project)||void 0===i?void 0:i.id)},o}();exports.DataManager=o,exports.DataStoreManager=n;
//# sourceMappingURL=index.min.js.map
