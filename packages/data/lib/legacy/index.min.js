/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";var e=require("@convertcom/js-sdk-utils"),t=require("@convertcom/js-sdk-enums"),i=function(){return i=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},i.apply(this,arguments)};function n(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],n=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function r(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,r,o=i.call(e),l=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)l.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}return l}"function"==typeof SuppressedError&&SuppressedError;var o=function(){function i(e,t){var i=void 0===t?{}:t,n=i.dataStore,r=i.eventManager,o=i.loggerManager;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=o,this._eventManager=r,this.batchSize=1,this.releaseInterval=5e3,this.dataStore=n,this._requestsQueue={}}return i.prototype.set=function(e,t){var i,n,r,o;try{null===(n=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===n||n.call(i,e,t)}catch(e){null===(o=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===o||o.call(r,"DataStoreManager.set()",{error:e.message})}},i.prototype.get=function(e){var t,i,n,r;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(r=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===r||r.call(n,"DataStoreManager.get()",{error:e.message})}return null},i.prototype.enqueue=function(t,i){var n={};n[t]=i,this._requestsQueue=e.objectDeepMerge(this._requestsQueue,n),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()},i.prototype.releaseQueue=function(e){var i,n;for(var r in this.stopQueue(),this._requestsQueue)this.set(r,this._requestsQueue[r]);null===(n=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===n||n.call(i,t.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})},i.prototype.stopQueue=function(){clearTimeout(this._requestsQueueTimerID)},i.prototype.startQueue=function(){var e=this;this._requestsQueueTimerID=setTimeout((function(){e.releaseQueue("timeout")}),this.releaseInterval)},Object.defineProperty(i.prototype,"dataStore",{get:function(){return this._dataStore},set:function(e){var i,n;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===n||n.call(i,t.ERROR_MESSAGES.DATA_STORE_NOT_VALID))},enumerable:!1,configurable:!0}),i.prototype.isValidDataStore=function(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set},i}(),l=function(){function l(i,n){var r,o,l,a=n.bucketingManager,u=n.ruleManager,s=n.eventManager,d=n.apiManager,c=n.loggerManager;this._dataEntities=t.DATA_ENTITIES,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==i?void 0:i.environment,this._apiManager=d,this._bucketingManager=a,this._ruleManager=u,this._loggerManager=c,this._eventManager=s,this._config=i,this._data=e.objectDeepValue(i,"data"),this._accountId=null===(r=this._data)||void 0===r?void 0:r.account_id,this._projectId=null===(l=null===(o=this._data)||void 0===o?void 0:o.project)||void 0===l?void 0:l.id,this.dataStoreManager=e.objectDeepValue(i,"dataStore")}return Object.defineProperty(l.prototype,"data",{get:function(){return this._data},set:function(e){var i,n,r;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(i=null==e?void 0:e.project)||void 0===i?void 0:i.id):null===(r=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===r||r.call(n,t.ERROR_MESSAGES.CONFIG_DATA_NOT_VALID)},enumerable:!1,configurable:!0}),Object.defineProperty(l.prototype,"dataStoreManager",{get:function(){return this._dataStoreManager},set:function(e){this._dataStoreManager=null,this._dataStoreManager=new o(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager})},enumerable:!1,configurable:!0}),l.prototype.matchRulesByField=function(e,i,r,o,l,a){var u,s,d,c,v,g,h,f,y,p,_,S,E;void 0===l&&(l="key"),void 0===a&&(a=this._environment);var M=this._getEntityByField(i,"experiences",l),m=!!this.getEntitiesList("archived_experiences").find((function(e){return String(null==M?void 0:M.id)===String(e)})),I=!Array.isArray(null==M?void 0:M.environments)||(!M.environments.length||M.environments.includes(a)),T=[];if(M&&!m&&I){var b=!1,A=[];if(o)if(Array.isArray(null==M?void 0:M.locations)&&M.locations.length){var O=this.getItemsByIds(M.locations,"locations");if(O.length&&(T=(A=this.selectLocations(e,O,o,l)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return T[0];b=Boolean(A.length)}else if(null==M?void 0:M.site_area){if(b=this._ruleManager.isRuleMatched(o,M.site_area,"SiteArea"),Object.values(t.RuleError).includes(b))return b}else b=!0;if(!o||b){var k=[],D=[],R=[],N=[];if(r)if(Array.isArray(null==M?void 0:M.audiences)&&M.audiences.length){if((k=this.getItemsByIds(M.audiences,"audiences")).length){if((T=(R=this.filterMatchedRecordsWithRule(k,r,"audience",l)).filter((function(e){return Object.values(t.RuleError).includes(e)}))).length)return T[0];if(R.length)try{for(var B=n(R),L=B.next();!L.done;L=B.next()){var C=L.value;null===(g=null===(v=this._loggerManager)||void 0===v?void 0:v.info)||void 0===g||g.call(v,t.MESSAGES.AUDIENCE_MATCH.replace("#",null==C?void 0:C[l]))}}catch(e){u={error:e}}finally{try{L&&!L.done&&(s=B.return)&&s.call(B)}finally{if(u)throw u.error}}}if((D=this.getItemsByIds(M.audiences,"segments")).length&&(N=this.filterMatchedCustomSegments(D,e)).length)try{for(var V=n(N),j=V.next();!j.done;j=V.next()){C=j.value;null===(f=null===(h=this._loggerManager)||void 0===h?void 0:h.info)||void 0===f||f.call(h,t.MESSAGES.SEGMENTATION_MATCH.replace("#",null==C?void 0:C[l]))}}catch(e){d={error:e}}finally{try{j&&!j.done&&(c=V.return)&&c.call(V)}finally{if(d)throw d.error}}}else null===(p=null===(y=this._loggerManager)||void 0===y?void 0:y.info)||void 0===p||p.call(y,t.MESSAGES.AUDIENCE_NOT_RESTRICTED);if((!r||R.length||N.length||!k.length)&&(null==M?void 0:M.variations)&&(null===(_=null==M?void 0:M.variations)||void 0===_?void 0:_.length))return null===(E=null===(S=this._loggerManager)||void 0===S?void 0:S.info)||void 0===E||E.call(S,t.MESSAGES.EXPERIENCE_RULES_MATCHED),M}}return null},l.prototype._getBucketingByField=function(e,i,n,r,o,l){void 0===o&&(o="key"),void 0===l&&(l=this._environment);var a=this.matchRulesByField(e,i,n,r,o,l);return a?Object.values(t.RuleError).includes(a)?a:this._retrieveBucketing(e,a):null},l.prototype._retrieveBucketing=function(e,n){var r,o,l,a,u,s,d,c,v,g,h,f;if(!e||!n)return null;if(!(null==n?void 0:n.id))return null;var y=null,p=null,_=this.getStoreKey(e),S=this.getLocalStore(e)||{},E=S.bucketing,M=S.locations,m=S.segments,I=(E||{})[n.id.toString()];if(I&&(y=this.retrieveVariation(n.id,I)))null===(a=null===(l=this._loggerManager)||void 0===l?void 0:l.info)||void 0===a||a.call(l,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#","#".concat(I)));else{var T=((null===(s=null===(u=this.dataStoreManager)||void 0===u?void 0:u.get)||void 0===s?void 0:s.call(u,_))||{}).bucketing,b=(void 0===T?{}:T)[n.id.toString()];if(b&&(y=this.retrieveVariation(n.id,b)))this.putLocalStore(e,i(i({bucketing:i(i({},E),(r={},r[n.id.toString()]=b,r))},M?{locations:M}:{}),m?{segments:m}:{})),null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===c||c.call(d,t.MESSAGES.BUCKETED_VISITOR_FOUND.replace("#","#".concat(b)));else{var A=n.variations.reduce((function(e,t){return(null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e}),{});if(b=this._bucketingManager.getBucketForVisitor(A,e)){null===(g=null===(v=this._loggerManager)||void 0===v?void 0:v.info)||void 0===g||g.call(v,t.MESSAGES.BUCKETED_VISITOR.replace("#","#".concat(b)));var O=i(i({bucketing:i(i({},E),(o={},o[n.id.toString()]=b,o))},M?{locations:M}:{}),m?{segments:m}:{});this.putLocalStore(e,O),this.dataStoreManager.enqueue(_,O);var k={experienceId:n.id.toString(),variationId:b.toString()},D={eventType:t.EventType.BUCKETING,data:k};this._apiManager.enqueue(e,D,m),y=this.retrieveVariation(n.id,b)}else null===(f=null===(h=this._loggerManager)||void 0===h?void 0:h.error)||void 0===f||f.call(h,t.ERROR_MESSAGES.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,{visitorId:e,experience:n})}}return y&&(p=i({experienceId:null==n?void 0:n.id,experienceName:null==n?void 0:n.name,experienceKey:null==n?void 0:n.key},y)),p},l.prototype.retrieveVariation=function(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")},l.prototype.putLocalStore=function(e,t){var i,o,l=this.getStoreKey(e);if(this._bucketedVisitors.set(l,t),this._bucketedVisitors.size>this._localStoreLimit)try{for(var a=n(this._bucketedVisitors),u=a.next();!u.done;u=a.next()){var s=r(u.value,2),d=s[0];s[1];this._bucketedVisitors.delete(d);break}}catch(e){i={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(i)throw i.error}}},l.prototype.getLocalStore=function(e){var t=this.getStoreKey(e);return this._bucketedVisitors.get(t)||null},l.prototype.getStoreKey=function(e){return"".concat(this._accountId,"-").concat(this._projectId,"-").concat(e)},l.prototype.selectLocations=function(n,r,o,l){var a,u,s,d,c,v,g,h,f,y,p,_,S,E,M,m;void 0===l&&(l="key");var I,T=this.getLocalStore(n)||{},b=T.bucketing,A=T.locations,O=void 0===A?[]:A,k=T.segments,D=[];if(e.arrayNotEmpty(r))for(var R=function(e,i){if(!(null===(a=null==r?void 0:r[e])||void 0===a?void 0:a.rules))return"continue";I=N._ruleManager.isRuleMatched(o,r[e].rules,"Location #".concat(r[e][l]));var T=null===(d=null===(s=null===(u=null==r?void 0:r[e])||void 0===u?void 0:u[l])||void 0===s?void 0:s.toString)||void 0===d?void 0:d.call(s);if(!0===I)null===(v=null===(c=N._loggerManager)||void 0===c?void 0:c.info)||void 0===v||v.call(c,t.MESSAGES.LOCATION_MATCH.replace("#","#".concat(T))),O.includes(T)||(O.push(T),N._eventManager.fire(t.SystemEvents.LOCATION_ACTIVATED,{visitorId:n,location:{id:null===(g=null==r?void 0:r[e])||void 0===g?void 0:g.id,key:null===(h=null==r?void 0:r[e])||void 0===h?void 0:h.key,name:null===(f=null==r?void 0:r[e])||void 0===f?void 0:f.name}},null,!0),null===(p=null===(y=N._loggerManager)||void 0===y?void 0:y.info)||void 0===p||p.call(y,t.MESSAGES.LOCATION_ACTIVATED.replace("#","#".concat(T)))),D.push(r[e]);else if(!1!==I)D.push(I);else if(!1===I&&O.includes(T)){N._eventManager.fire(t.SystemEvents.LOCATION_DEACTIVATED,{visitorId:n,location:{id:null===(_=null==r?void 0:r[e])||void 0===_?void 0:_.id,key:null===(S=null==r?void 0:r[e])||void 0===S?void 0:S.key,name:null===(E=null==r?void 0:r[e])||void 0===E?void 0:E.name}},null,!0);var b=O.findIndex((function(e){return e===T}));O.splice(b,1),null===(m=null===(M=N._loggerManager)||void 0===M?void 0:M.info)||void 0===m||m.call(M,t.MESSAGES.LOCATION_DEACTIVATED.replace("#","#".concat(T)))}},N=this,B=0,L=r.length;B<L;B++)R(B);return this.putLocalStore(n,i(i(i({},b?{bucketing:b}:{}),{locations:O}),k?{segments:k}:{})),D},l.prototype.getBucketing=function(e,t,i,n,r){return void 0===r&&(r=this._environment),this._getBucketingByField(e,t,i,n,"key",r)},l.prototype.getBucketingById=function(e,t,i,n,r){return void 0===r&&(r=this._environment),this._getBucketingByField(e,t,i,n,"id",r)},l.prototype.convert=function(e,i,n,r,o){var l,a,u,s,d="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(null==d?void 0:d.id){if(n){if(!(null==d?void 0:d.rules))return;var c=this._ruleManager.isRuleMatched(n,d.rules,"Goal #".concat(i));if(Object.values(t.RuleError).includes(c))return c;if(!c)return void(null===(s=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===s||s.call(u,t.MESSAGES.GOAL_RULE_NOT_MATCH))}var v={goalId:d.id},g=(this.getLocalStore(e)||{}).bucketing;g&&(v.bucketingData=g);var h={eventType:t.EventType.CONVERSION,data:v};if(this._apiManager.enqueue(e,h,o),r){var f={goalId:d.id,goalData:r};g&&(f.bucketingData=g);var y={eventType:t.EventType.CONVERSION,data:f};this._apiManager.enqueue(e,y,o)}}else null===(a=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===a||a.call(l,t.MESSAGES.GOAL_NOT_FOUND)},l.prototype.filterMatchedRecordsWithRule=function(t,i,n,r){var o;void 0===r&&(r="id");var l,a=[];if(e.arrayNotEmpty(t))for(var u=0,s=t.length;u<s;u++)(null===(o=null==t?void 0:t[u])||void 0===o?void 0:o.rules)&&(!0===(l=this._ruleManager.isRuleMatched(i,t[u].rules,"".concat(e.camelCase(n)," #").concat(t[u][r])))?a.push(t[u]):!1!==l&&a.push(l));return a},l.prototype.filterMatchedCustomSegments=function(i,n){var r,o=(this.getLocalStore(n)||{}).segments,l=(void 0===o?{}:o)[t.SegmentsKeys.CUSTOM_SEGMENTS],a=void 0===l?[]:l,u=[];if(e.arrayNotEmpty(i))for(var s=0,d=i.length;s<d;s++)(null===(r=null==i?void 0:i[s])||void 0===r?void 0:r.id)&&a.includes(i[s].id)&&u.push(i[s]);return u},l.prototype.getEntitiesList=function(t){var i=[];return-1!==this._dataEntities.indexOf(t)&&(i=e.objectDeepValue(this._data,t)||[]),i},l.prototype.getEntitiesListObject=function(e,t){return void 0===t&&(t="id"),this.getEntitiesList(e).reduce((function(e,i){return e[i[t]]=i,e}),{})},l.prototype._getEntityByField=function(t,i,n){var r;void 0===n&&(n="key");var o=this.getEntitiesList(i);if(e.arrayNotEmpty(o))for(var l=0,a=o.length;l<a;l++)if(o[l]&&String(null===(r=o[l])||void 0===r?void 0:r[n])===String(t))return o[l];return null},l.prototype.getEntity=function(e,t){return this._getEntityByField(e,t,"key")},l.prototype.getEntities=function(e,t){return this.getItemsByKeys(e,t)},l.prototype.getEntityById=function(e,t){return this._getEntityByField(e,t,"id")},l.prototype.getEntitiesByIds=function(e,t){return this.getItemsByIds(e,t)},l.prototype.getItemsByKeys=function(t,i){var n,r=this.getEntitiesList(i),o=[];if(e.arrayNotEmpty(r))for(var l=0,a=r.length;l<a;l++)-1!==t.indexOf(null===(n=r[l])||void 0===n?void 0:n.key)&&o.push(r[l]);return o},l.prototype.getItemsByIds=function(t,i){var n,r,o=[];if(e.arrayNotEmpty(t)){var l=this.getEntitiesList(i);if(e.arrayNotEmpty(l))for(var a=0,u=l.length;a<u;a++)-1===t.indexOf(Number(null===(n=l[a])||void 0===n?void 0:n.id))&&-1===t.indexOf(String(null===(r=l[a])||void 0===r?void 0:r.id))||o.push(l[a])}return o},l.prototype.getSubItem=function(e,t,i,n,r,o){var l,a=this._getEntityByField(t,e,r);for(var u in a[i])if(String(null===(l=a[i][u])||void 0===l?void 0:l[o])===String(n))return a[i][u];return null},l.prototype.isValidConfigData=function(t){var i;return e.objectNotEmpty(t)&&!!(null==t?void 0:t.account_id)&&!!(null===(i=null==t?void 0:t.project)||void 0===i?void 0:i.id)},l}();exports.DataManager=l,exports.DataStoreManager=o;
//# sourceMappingURL=index.min.js.map
